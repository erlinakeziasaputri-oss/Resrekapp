<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Sistem Rekapitulasi Juara Profesional - ResRekap Pro">
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ResRekap Pro - Professional Tabulation System</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèÜ</text></svg>">

    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiUmVzUmVrYXAgUHJvIiwic2hvcnRfbmFtZSI6IlJlc1Jla2FwIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmOGZhZmMiLCJ0aGVtZV9jb2xvciI6IiM0ZjQ2ZTUiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9jZG4uanNkZWxpdnIubmV0L2doL3R3YnMvaWNvbnNAbWFpbi9pY29ucy90cm9waHkuc3ZnIiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwifV19">

    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Load React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- 3. Load Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 5. Load html2pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- 6. FIREBASE SDK (Compat Version for Standalone HTML) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }

        /* Scrollbar Refinement */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .modal-overlay {
            background-color: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
        }

        #pdf-fullscreen-container {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background-color: #1e293b; z-index: 9000; overflow-y: auto;
            display: flex; justify-content: center; padding: 40px 0; align-items: flex-start;
        }

        #pdf-content {
            width: 210mm; min-height: 297mm; background: white; padding: 15mm 10mm;
            box-sizing: border-box; color: #0f172a; font-family: 'Times New Roman', serif;
            position: relative; display: flex; flex-direction: column; margin: 0 auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        #pdf-loading-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(255,255,255,0.9); z-index: 10000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(8px);
        }

        .pdf-table { width: 100%; border-collapse: collapse; font-size: 10pt; margin-bottom: 20px; }
        .pdf-table th { border: 1px solid #000; background-color: #f1f5f9; padding: 8px 6px; font-weight: bold; text-transform: uppercase; }
        .pdf-table td { border: 1px solid #000; padding: 6px; vertical-align: middle; }
        
        .preview-modal-content { width: 215mm; max-width: 95vw; height: 85vh; background: #334155; overflow-y: auto; border-radius: 12px; padding: 30px; display: flex; justify-content: center; }

        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .glass-card { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .bg-pattern { background-color: #f8fafc; background-image: radial-gradient(#e2e8f0 1px, transparent 1px); background-size: 24px 24px; }
    </style>
</head>
<body class="bg-[#f8fafc] text-slate-900 h-screen overflow-hidden">
    
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        //  KONFIGURASI FIREBASE
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyB4xfUu83UGqMDNoECaMndBrI0MoSYgbl8",
            authDomain: "resrekap.firebaseapp.com",
            projectId: "resrekap",
            storageBucket: "resrekap.firebasestorage.app",
            messagingSenderId: "644884929137",
            appId: "1:644884929137:web:f64bb70a2a5ad18f32d9d0"
        };

        // Inisialisasi Firebase
        let db;
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            db = firebase.firestore();
            db.enablePersistence().catch(err => {
                if (err.code == 'failed-precondition') {
                    console.log("Persistence failed: Multiple tabs open");
                } else if (err.code == 'unimplemented') {
                    console.log("Persistence not supported");
                }
            });
        } catch (error) {
            console.error("Firebase Init Error:", error);
        }

        // --- UTILS & ICONS ---
        const IconBridge = ({ name, size = 20, className = "", ...props }) => {
            const iconData = lucide.icons[name];
            if (!iconData) return null;
            return React.createElement('svg', {
                ...props, width: size, height: size, viewBox: "0 0 24 24",
                fill: "none", stroke: "currentColor", strokeWidth: 2,
                strokeLinecap: "round", strokeLinejoin: "round",
                className: `lucide lucide-${name} ${className}`,
            }, ...iconData.map(([tag, attrs]) => React.createElement(tag, attrs)));
        };

        const Icons = {
            Dashboard: (p) => <IconBridge name="LayoutDashboard" {...p} />,
            Event: (p) => <IconBridge name="Layers" {...p} />,
            Recap: (p) => <IconBridge name="ClipboardEdit" {...p} />,
            Report: (p) => <IconBridge name="FileBarChart" {...p} />,
            Settings: (p) => <IconBridge name="Sliders" {...p} />,
            Plus: (p) => <IconBridge name="Plus" {...p} />,
            Trash: (p) => <IconBridge name="Trash2" {...p} />,
            Edit: (p) => <IconBridge name="Pencil" {...p} />,
            Save: (p) => <IconBridge name="Save" {...p} />,
            Users: (p) => <IconBridge name="Users" {...p} />,
            Trophy: (p) => <IconBridge name="Trophy" {...p} />,
            Download: (p) => <IconBridge name="Download" {...p} />,
            Back: (p) => <IconBridge name="ChevronLeft" {...p} />,
            Check: (p) => <IconBridge name="Check" {...p} />,
            Max: (p) => <IconBridge name="Expand" {...p} />,
            Min: (p) => <IconBridge name="Shrink" {...p} />,
            Upload: (p) => <IconBridge name="UploadCloud" {...p} />,
            Image: (p) => <IconBridge name="Image" {...p} />,
            X: (p) => <IconBridge name="X" {...p} />,
            Loader: (p) => <IconBridge name="Loader2" {...p} />,
            Merge: (p) => <IconBridge name="Combine" {...p} />,
            Lock: (p) => <IconBridge name="Lock" {...p} />,
            Unlock: (p) => <IconBridge name="Unlock" {...p} />,
            ArrowUp: (p) => <IconBridge name="ArrowUp" {...p} />,
            ArrowDown: (p) => <IconBridge name="ArrowDown" {...p} />,
            Sheet: (p) => <IconBridge name="FileSpreadsheet" {...p} />,
            Eye: (p) => <IconBridge name="Eye" {...p} />, 
            Briefcase: (p) => <IconBridge name="Briefcase" {...p} />,
            UserCog: (p) => <IconBridge name="UserCog" {...p} />,
            LogOut: (p) => <IconBridge name="LogOut" {...p} />,
            Key: (p) => <IconBridge name="KeyRound" {...p} />,
            Alert: (p) => <IconBridge name="AlertTriangle" {...p} />,
            Ticket: (p) => <IconBridge name="Ticket" {...p} />,
            Search: (p) => <IconBridge name="Search" {...p} />,
            Printer: (p) => <IconBridge name="Printer" {...p} />,
        };

        const { useState, useEffect, useRef } = React;
        const generateId = () => Math.random().toString(36).substr(2, 9);

        // --- UTILS ---
        const resizeImage = (file, maxWidth = 400) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.createElement('img');
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.92));
                    };
                    img.onerror = reject;
                    img.src = e.target.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        };

        const generateToken = () => {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Avoid ambiguous chars
            let token = '';
            for (let i = 0; i < 6; i++) {
                token += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return token;
        };

        const generateTokenCardImage = async (event, participant, token) => {
            // HIGH QUALITY SCALE (3x)
            const scale = 3;
            const width = 600 * scale;
            const height = 350 * scale;

            const canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            
            // Set scaling for High DPI
            ctx.scale(scale, scale);

            // Background Gradient
            const grd = ctx.createLinearGradient(0, 0, 600, 350);
            grd.addColorStop(0, "#4f46e5");
            grd.addColorStop(1, "#312e81");
            ctx.fillStyle = grd;
            ctx.fillRect(0, 0, 600, 350);

            // Pattern Overlay
            ctx.fillStyle = "rgba(255,255,255,0.05)";
            ctx.beginPath(); ctx.arc(500, -50, 150, 0, 2 * Math.PI); ctx.fill();
            ctx.beginPath(); ctx.arc(50, 400, 120, 0, 2 * Math.PI); ctx.fill();

            // Text Header
            ctx.fillStyle = "#ffffff";
            ctx.font = "bold 24px 'Segoe UI', sans-serif";
            ctx.fillText("KARTU AKSES NILAI", 40, 50);

            ctx.font = "16px 'Segoe UI', sans-serif";
            ctx.fillStyle = "rgba(255,255,255,0.8)";
            ctx.fillText(event.name, 40, 80);

            // Logo
            if (event.logo) {
                try {
                    const img = new Image();
                    img.src = event.logo;
                    await new Promise((resolve) => { img.onload = resolve; img.onerror = resolve; });
                    const aspect = img.width / img.height;
                    const h = 60;
                    const w = h * aspect;
                    // Draw image nicely
                    ctx.drawImage(img, 540 - w, 30, w, h);
                } catch (e) { console.error(e); }
            }

            // Participant Box
            ctx.fillStyle = "rgba(255,255,255,0.1)";
            ctx.fillRect(40, 110, 520, 100);
            
            ctx.fillStyle = "#ffffff";
            ctx.font = "bold 32px 'Segoe UI', sans-serif";
            ctx.fillText(participant.name, 60, 155);
            ctx.font = "18px 'Segoe UI', sans-serif";
            ctx.fillText(`ID Peserta: ${participant.number}`, 60, 185); 

            // Token Display
            ctx.fillStyle = "#ffffff";
            ctx.font = "bold 60px 'Courier New', monospace";
            ctx.textAlign = "center";
            ctx.fillText(token, 300, 290);
            
            // Footer
            ctx.font = "italic 12px 'Segoe UI', sans-serif";
            ctx.fillStyle = "rgba(255,255,255,0.6)";
            ctx.textAlign = "center";
            ctx.fillText("Rekap oleh ResRekap", 300, 330);

            return canvas.toDataURL('image/png', 1.0);
        };

        const downloadToken = async (event, p, token) => {
             const url = await generateTokenCardImage(event, p, token);
             const link = document.createElement('a');
             link.download = `Token_${p.name.replace(/\s+/g, '_')}.png`;
             link.href = url;
             link.click();
        };

        const printToken = async (event, p, token) => {
             const url = await generateTokenCardImage(event, p, token);
             const win = window.open('');
             win.document.write(`<html><head><title>Cetak Token - ${p.name}</title></head><body style="margin:0; display:flex; justify-content:center; align-items:center; height:100vh;"><img src="${url}" style="max-width:100%; height:auto;"/></body><script>window.onload = function() { window.print(); window.close(); }<\/script></html>`);
        };

        // --- PDF GENERATOR ---
        const generatePDF = (elementId, fileName, callback) => {
            const element = document.getElementById(elementId);
            if(!element) { alert("Error: Template PDF tidak ditemukan."); if(callback) callback(); return; }
            window.scrollTo(0, 0);
            const opt = {
                margin: 0, filename: `${fileName}.pdf`, image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, letterRendering: true, scrollY: 0 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
            };
            html2pdf().set(opt).from(element).save().then(() => { if(callback) callback(); }).catch(err => { alert("Gagal membuat PDF."); if(callback) callback(); });
        };

        const RANK_PALETTE = ['bg-yellow-100 border-yellow-200', 'bg-red-50 border-red-100', 'bg-orange-100 border-orange-200', 'bg-red-100 border-red-200', 'bg-amber-100 border-amber-200', 'bg-emerald-50 border-emerald-100'];
        const RANK_PALETTE_PDF = ['#fef9c3', '#fef2f2', '#ffedd5', '#fee2e2', '#fef3c7', '#ecfdf5'];

        // --- CALCULATION LOGIC ---
        const getAspectScore = (p, catId, aspId, judgeCount) => {
            const scores = p.scores?.[catId]?.[aspId] || {};
            let total = 0;
            for(let j=1; j<=judgeCount; j++) total += (scores[j] || 0);
            return total / Math.max(1, judgeCount) || 0;
        };
        const getCategoryTotal = (p, cat) => cat.aspects.reduce((sum, asp) => sum + getAspectScore(p, cat.id, asp.id, cat.judgeCount), 0);
        const getCustomTotal = (p, categories) => categories.reduce((sum, cat) => sum + getCategoryTotal(p, cat), 0);

        // --- COMPONENTS ---
        const ModalWrapper = ({ children, isOpen, onClose }) => {
            if (!isOpen) return null;
            return ( <div className="fixed inset-0 z-[100] modal-overlay overflow-y-auto grid place-items-center p-4" onClick={onClose}> <div className="relative bg-white w-full max-w-lg rounded-[24px] shadow-2xl animate-fade-in my-8 overflow-hidden" onClick={e => e.stopPropagation()}> {children} </div> </div> );
        };

        const PreviewModal = ({ isOpen, onClose, children }) => {
            if (!isOpen) return null;
            return ( <div className="fixed inset-0 z-[100] modal-overlay flex items-center justify-center p-4"> <div className="relative animate-fade-in flex flex-col items-center w-full"> <div className="flex justify-between items-center w-full max-w-4xl px-4 mb-4 text-white"> <h3 className="text-xl font-bold tracking-tight">Dokumen Pratinjau</h3> <button onClick={onClose} className="p-2 bg-white/10 rounded-full hover:bg-white/20 transition-all"><Icons.X /></button> </div> <div className="preview-modal-content shadow-2xl"> <div style={{background: 'white', padding: '15mm 10mm', width: '100%', minHeight: '100%'}}> {children} </div> </div> </div> </div> );
        };

        // Custom Modal for Token Actions
        const TokenActionModal = ({ isOpen, onClose, event, participant, token }) => {
            if(!isOpen) return null;
            return (
                <ModalWrapper isOpen={isOpen} onClose={onClose}>
                    <div className="p-8 text-center">
                        <div className="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4"><Icons.Key size={32}/></div>
                        <h3 className="text-2xl font-black text-slate-800 mb-2">Token Akses Peserta</h3>
                        <p className="text-slate-500 mb-6">Gunakan token ini untuk login peserta.</p>
                        
                        <div className="bg-slate-100 p-4 rounded-xl border border-slate-200 mb-6">
                            <p className="text-4xl font-mono font-bold text-slate-800 tracking-widest">{token}</p>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <button onClick={() => { downloadToken(event, participant, token); onClose(); }} className="py-3 bg-white border-2 border-slate-200 text-slate-700 hover:border-indigo-600 hover:text-indigo-600 rounded-xl font-bold flex items-center justify-center gap-2 transition-all">
                                <Icons.Download size={18}/> Unduh
                            </button>
                            <button onClick={() => { printToken(event, participant, token); onClose(); }} className="py-3 bg-indigo-600 text-white hover:bg-indigo-700 rounded-xl font-bold flex items-center justify-center gap-2 transition-all">
                                <Icons.Printer size={18}/> Cetak
                            </button>
                        </div>
                    </div>
                </ModalWrapper>
            );
        };

        const SimpleModal = ({ isOpen, title, type = 'input', message, onConfirm, onCancel, placeholder, defaultValue = '', confirmBtnText }) => {
            const [val, setVal] = useState(defaultValue);
            const inputRef = useRef(null);
            
            useEffect(() => { 
                if (isOpen) { 
                    setVal(defaultValue || ''); 
                    setTimeout(() => { if (inputRef.current) inputRef.current.focus(); }, 50); 
                } 
            }, [isOpen, defaultValue]);
            
            const isPassword = title ? (title.toLowerCase().includes("password") || title.toLowerCase().includes("pin")) : false;
            
            if(!isOpen) return null;
            return ( 
                <ModalWrapper isOpen={isOpen} onClose={onCancel}> 
                    <div className="p-8"> 
                        <div className="flex justify-between items-center mb-6"> 
                            <h3 className="text-2xl font-extrabold text-slate-900 tracking-tight">{title}</h3> 
                            <button onClick={onCancel} className="text-slate-400 hover:text-slate-600 transition-colors"><Icons.X size={20}/></button> 
                        </div> 
                        {type === 'confirm' ? ( 
                            <p className="text-slate-600 mb-8 text-lg leading-relaxed">{message}</p> 
                        ) : ( 
                            <div className="mb-8"> 
                                <label className="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Input Data</label> 
                                <input 
                                    ref={inputRef} 
                                    type={isPassword ? "password" : "text"} 
                                    className="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none transition-all font-medium text-slate-800" 
                                    placeholder={placeholder} 
                                    value={val} 
                                    onChange={e=>setVal(e.target.value)} 
                                    onKeyDown={e => e.key === 'Enter' && onConfirm(val)} 
                                    autoComplete="new-password"
                                /> 
                            </div> 
                        )} 
                        <div className="flex justify-end gap-3"> 
                            <button onClick={onCancel} className="px-6 py-3 text-slate-500 hover:bg-slate-100 rounded-xl font-bold transition-all">Batal</button> 
                            <button 
                                onClick={() => onConfirm(type==='input'?val:true)} 
                                className={`px-8 py-3 rounded-xl shadow-lg transition-all font-bold text-white ${type === 'confirm' ? 'bg-red-500 hover:bg-red-600 shadow-red-100' : 'bg-indigo-600 hover:bg-indigo-700 shadow-indigo-100'}`}
                            > 
                                {confirmBtnText || (type === 'confirm' ? 'Hapus' : 'Lanjutkan')} 
                            </button> 
                        </div> 
                    </div> 
                </ModalWrapper> 
            );
        };

        const SidebarLink = ({ active, icon, label, onClick }) => ( <button onClick={onClick} className={`w-full flex items-center gap-4 px-4 py-3 rounded-2xl transition-all duration-300 font-semibold group ${active ? 'bg-white text-indigo-700 shadow-md' : 'text-slate-400 hover:bg-white/5 hover:text-white'}`}> <span className={`${active ? 'text-indigo-600' : 'group-hover:text-indigo-400'} transition-colors`}>{icon}</span> <span className="tracking-tight text-sm">{label}</span> </button> );

        // --- AUTH COMPONENTS ---
        const LoginView = ({ users, onLogin, onTokenCheck, dbStatus, settings }) => {
            const [mode, setMode] = useState('admin');
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [token, setToken] = useState('');
            const [error, setError] = useState('');
            const [checking, setChecking] = useState(false);

            const handleAdminLogin = (e) => {
                e.preventDefault();
                const user = users.find(u => u.username.toLowerCase() === username.toLowerCase() && u.password === password);
                if (user) onLogin(user); else setError('Username atau password salah');
            };

            const handleTokenCheck = async (e) => {
                e.preventDefault();
                if(!token) return setError("Masukkan token akses.");
                setChecking(true);
                setError('');
                const result = await onTokenCheck(token.toUpperCase());
                setChecking(false);
                if (!result) setError("Token tidak ditemukan atau tidak valid.");
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4 bg-pattern">
                    <div className="bg-white p-10 rounded-[40px] shadow-2xl w-full max-w-md border border-slate-200 backdrop-blur-lg bg-white/90">
                        <div className="text-center mb-8">
                            <div className="mx-auto mb-6 w-24 h-24 bg-white rounded-3xl shadow-xl flex items-center justify-center overflow-hidden border border-slate-100">
                                {settings && settings.appLogo ? ( <img src={settings.appLogo} alt="Logo" className="w-full h-full object-contain" /> ) : ( <div className="text-4xl font-black text-indigo-600">R</div> )}
                            </div>
                            <h1 className="text-3xl font-black text-slate-800 tracking-tight mb-1">ResRekap</h1>
                            <p className="text-slate-500 font-medium text-sm">Professional Online System</p>
                            <p className="text-[10px] font-bold text-indigo-400 mt-2 tracking-widest uppercase">by Respati Team</p>
                            {dbStatus === 'error' && <div className="mt-6 p-3 bg-red-50 text-red-600 text-xs rounded-xl border border-red-100 flex items-center gap-2 text-left"><Icons.Alert size={16} className="shrink-0"/> Database tidak terhubung.</div>}
                        </div>

                        <div className="flex bg-slate-100 p-1.5 rounded-2xl mb-8 border border-slate-200">
                            <button onClick={()=>{setMode('admin'); setError('');}} className={`flex-1 py-2.5 text-sm font-bold rounded-xl transition-all ${mode==='admin' ? 'bg-white text-indigo-600 shadow-md ring-1 ring-slate-200' : 'text-slate-400 hover:text-slate-600'}`}>Admin</button>
                            <button onClick={()=>{setMode('participant'); setError('');}} className={`flex-1 py-2.5 text-sm font-bold rounded-xl transition-all ${mode==='participant' ? 'bg-white text-indigo-600 shadow-md ring-1 ring-slate-200' : 'text-slate-400 hover:text-slate-600'}`}>Peserta</button>
                        </div>

                        {mode === 'admin' ? (
                            <form onSubmit={handleAdminLogin} className="space-y-5">
                                <div><label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 ml-1">Username</label><div className="relative"><div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-400"><Icons.Users size={18}/></div><input autoFocus type="text" className="w-full pl-12 p-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none transition-all font-bold text-slate-800" placeholder="Username" value={username} onChange={e=>setUsername(e.target.value)} autoComplete="off"/></div></div>
                                <div><label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 ml-1">Password</label><div className="relative"><div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-400"><Icons.Key size={18}/></div><input type="password" className="w-full pl-12 p-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none transition-all font-bold text-slate-800" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value={password} onChange={e=>setPassword(e.target.value)} autoComplete="new-password"/></div></div>
                                {error && <p className="text-red-500 text-xs font-bold text-center bg-red-50 p-3 rounded-xl border border-red-100">{error}</p>}
                                <button type="submit" className="w-full py-4 bg-indigo-600 text-white rounded-2xl font-black shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-all transform hover:scale-[1.02]">Masuk Aplikasi</button>
                            </form>
                        ) : (
                            <form onSubmit={handleTokenCheck} className="space-y-5">
                                <div><label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 ml-1">Token Akses</label><div className="relative"><div className="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-400"><Icons.Ticket size={18}/></div><input autoFocus type="text" className="w-full pl-12 p-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none transition-all font-black text-slate-800 uppercase tracking-widest text-lg" placeholder="X7Y2Z1" value={token} onChange={e=>setToken(e.target.value.toUpperCase())} maxLength={6} autoComplete="off"/></div></div>
                                {error && <p className="text-red-500 text-xs font-bold text-center bg-red-50 p-3 rounded-xl border border-red-100">{error}</p>}
                                <button type="submit" disabled={checking} className="w-full py-4 bg-indigo-600 text-white rounded-2xl font-black shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-all transform hover:scale-[1.02] flex items-center justify-center gap-2">{checking ? <Icons.Loader className="animate-spin" size={18}/> : <><Icons.Search size={18}/> Cek Hasil Saya</>}</button>
                            </form>
                        )}
                    </div>
                </div>
            );
        };

        const ParticipantView = ({ session, onLogout }) => {
            const { event, participant } = session;
            // State for expansion for both main categories and custom reports
            const [expandedCats, setExpandedCats] = useState({});
            const [expandedReports, setExpandedReports] = useState({});

            const toggleCat = (catId) => setExpandedCats(prev => ({ ...prev, [catId]: !prev[catId] }));
            const toggleReport = (repId) => setExpandedReports(prev => ({ ...prev, [repId]: !prev[repId] }));

            return (
                <div className="h-screen bg-slate-50 overflow-auto bg-pattern">
                    <div className="max-w-3xl mx-auto bg-white min-h-screen shadow-2xl border-x border-slate-100">
                        <div className="bg-indigo-600 p-10 text-white relative overflow-hidden rounded-b-[50px] shadow-lg mb-8">
                            <div className="absolute top-0 right-0 w-64 h-64 bg-white/5 rounded-full -mr-20 -mt-20"></div>
                            <div className="relative z-10">
                                <div className="flex justify-between items-start mb-6">
                                    <button onClick={onLogout} className="px-4 py-2 bg-white/20 hover:bg-white/30 text-white rounded-xl text-xs font-bold flex items-center gap-2 backdrop-blur-sm transition-all"><Icons.Back size={14}/> Cek Token Lain</button>
                                    <h4 className="text-xs font-black uppercase tracking-[0.2em] opacity-60">Laporan Individu</h4>
                                </div>
                                <h1 className="text-4xl font-black mb-2 tracking-tight leading-tight">{participant.name}</h1>
                                <p className="font-bold opacity-80 mb-8 text-indigo-200">Nomor Undian: <span className="text-white">{participant.number}</span></p>
                                <div className="flex flex-wrap justify-between items-end gap-4">
                                    <div className="flex items-center gap-3 text-xs font-bold uppercase tracking-widest bg-black/20 w-fit px-5 py-3 rounded-2xl backdrop-blur-sm border border-white/10"><Icons.Trophy size={16} className="text-yellow-400"/> <span>Event: {event.name}</span></div>
                                    <div className="text-right bg-white/10 px-5 py-3 rounded-2xl backdrop-blur-sm border border-white/10"><p className="text-[9px] uppercase font-black tracking-widest opacity-60 mb-1">Total Skor Akhir</p><p className="text-4xl font-black leading-none">{getCustomTotal(participant, event.categories).toFixed(2)}</p></div>
                                </div>
                            </div>
                        </div>
                        
                        <div className="p-8 space-y-6 pb-32">
                            {/* MATA LOMBA UTAMA */}
                            {event.categories.map((cat) => {
                                const isExpanded = expandedCats[cat.id];
                                return (
                                    <div key={cat.id} className="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden transition-all duration-300 hover:shadow-md">
                                        <div 
                                            onClick={() => toggleCat(cat.id)}
                                            className={`px-6 py-5 border-b flex justify-between items-center cursor-pointer transition-colors ${isExpanded ? 'bg-slate-50' : 'bg-white hover:bg-slate-50'}`}
                                        >
                                            <div className="flex items-center gap-5">
                                                <div className={`p-2 rounded-xl bg-slate-100 text-slate-400 transition-transform duration-300 ${isExpanded ? 'rotate-180 bg-indigo-100 text-indigo-600' : ''}`}>
                                                    <Icons.ArrowDown size={18}/>
                                                </div>
                                                <h3 className="font-bold text-base text-slate-800 uppercase tracking-wide">{cat.name}</h3>
                                            </div>
                                            <div className="px-5 py-2 rounded-xl text-sm font-black tracking-widest uppercase bg-indigo-50 text-indigo-600 border border-indigo-100">
                                                {getCategoryTotal(participant, cat).toFixed(2)}
                                            </div>
                                        </div>

                                        {isExpanded && (
                                            <div className="animate-fade-in bg-slate-50/50">
                                                <table className="w-full text-left">
                                                    <thead>
                                                        <tr className="text-[9px] font-bold text-slate-400 uppercase tracking-widest border-b border-slate-200">
                                                            <th className="px-8 py-4 w-1/3">Aspek Penilaian</th>
                                                            {Array.from({length:cat.judgeCount}).map((_,i)=><th key={i} className="px-4 py-4 text-center">Juri {i+1}</th>)}
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y divide-slate-200">
                                                        {cat.aspects.map((asp) => (
                                                            <tr key={asp.id} className="hover:bg-white transition-colors">
                                                                <td className="px-8 py-3 align-middle">
                                                                    <div className="font-bold text-slate-700 text-sm leading-tight">{asp.name}</div>
                                                                    <div className="text-[9px] text-slate-400 font-bold mt-1 bg-white border border-slate-200 px-2 py-0.5 rounded w-fit uppercase tracking-wider">Max: {asp.maxScore}</div>
                                                                </td>
                                                                {Array.from({length:cat.judgeCount}).map((_,i) => (
                                                                    <td key={i} className="px-4 py-3 text-center">
                                                                        <span className="font-black text-slate-600 text-base">
                                                                            {participant.scores?.[cat.id]?.[asp.id]?.[i+1] || '-'}
                                                                        </span>
                                                                    </td>
                                                                ))}
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}

                            {/* MATA LOMBA GABUNGAN */}
                            {event.custom_reports && event.custom_reports.length > 0 && (
                                <div className="mt-8">
                                    <h3 className="text-xs font-black uppercase tracking-widest text-slate-400 mb-4 ml-2">Kategori Gabungan</h3>
                                    <div className="grid gap-4">
                                        {event.custom_reports.map(cr => {
                                            const cats = event.categories.filter(c => cr.categoryIds.includes(c.id));
                                            const isExpanded = expandedReports[cr.id];
                                            
                                            return (
                                                <div key={cr.id} className="bg-indigo-50 rounded-3xl border border-indigo-100 overflow-hidden transition-all duration-300">
                                                    <div 
                                                        onClick={() => toggleReport(cr.id)}
                                                        className="p-6 flex justify-between items-center cursor-pointer"
                                                    >
                                                        <div>
                                                            <h4 className="font-bold text-indigo-900 text-lg flex items-center gap-2">
                                                                {cr.name}
                                                                <div className={`transition-transform duration-300 ${isExpanded ? 'rotate-180' : ''}`}><Icons.ArrowDown size={16} className="text-indigo-400"/></div>
                                                            </h4>
                                                            <p className="text-[10px] text-indigo-400 font-bold uppercase tracking-widest mt-1">Gabungan {cats.length} Mata Lomba</p>
                                                        </div>
                                                        <div className="text-3xl font-black text-indigo-600">{getCustomTotal(participant, cats).toFixed(2)}</div>
                                                    </div>

                                                    {/* Expanded Breakdown */}
                                                    {isExpanded && (
                                                        <div className="bg-white/50 border-t border-indigo-100 p-4 animate-fade-in">
                                                            <div className="space-y-2">
                                                                {cats.map(c => (
                                                                    <div key={c.id} className="flex justify-between items-center bg-white p-3 rounded-xl border border-indigo-50">
                                                                        <span className="text-indigo-900 font-bold text-sm">{c.name}</span>
                                                                        <span className="font-black text-indigo-600">{getCategoryTotal(participant, c).toFixed(2)}</span>
                                                                    </div>
                                                                ))}
                                                                <div className="flex justify-between items-center px-3 pt-2">
                                                                    <span className="text-[10px] uppercase font-black tracking-widest text-indigo-400">Total Akumulasi</span>
                                                                    <span className="font-black text-indigo-800 text-lg">{getCustomTotal(participant, cats).toFixed(2)}</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}
                        </div>
                        
                        <div className="fixed bottom-8 left-1/2 transform -translate-x-1/2 z-50">
                            <button onClick={onLogout} className="px-10 py-4 bg-slate-900 text-white rounded-full font-bold hover:bg-indigo-600 transition-all shadow-2xl shadow-indigo-500/30 flex items-center gap-3 transform hover:scale-105">
                                <Icons.LogOut size={18}/> Keluar Aplikasi
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const AccountManagerView = ({ users, addUser, deleteUser }) => (
            <div className="animate-fade-in max-w-4xl mx-auto pb-20">
                <header className="mb-10"><h1 className="text-3xl font-black text-slate-900 tracking-tight leading-none">Manajemen Akun</h1><p className="text-slate-500 font-medium mt-2 text-sm">Kelola akses pengguna aplikasi (Online Sync).</p></header>
                <div className="bg-white p-8 rounded-[32px] shadow-sm border border-slate-100">
                    <div className="flex justify-between items-center mb-8"><h3 className="text-xl font-black text-slate-800 flex items-center gap-3"><Icons.Users size={24} className="text-indigo-600"/> Daftar Pengguna</h3><button onClick={addUser} className="px-6 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition-all flex items-center gap-2 text-sm"><Icons.Plus size={16}/> Tambah Akun</button></div>
                    <div className="overflow-hidden rounded-2xl border border-slate-100"><table className="w-full text-left"><thead className="bg-slate-50 text-[10px] font-black text-slate-400 uppercase tracking-widest"><tr><th className="px-6 py-4">Username</th><th className="px-6 py-4">Password</th><th className="px-6 py-4 text-right">Aksi</th></tr></thead><tbody className="divide-y divide-slate-100">{users.map((u, i) => (<tr key={u.id || i} className="hover:bg-slate-50/50 transition-colors"><td className="px-6 py-4 font-bold text-slate-800">{u.username} {i===0 && <span className="ml-2 bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded text-[9px] font-black uppercase">Default</span>}</td><td className="px-6 py-4 font-mono text-slate-500 text-sm">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</td><td className="px-6 py-4 text-right"><button onClick={()=>deleteUser(u)} className="p-2 text-slate-400 hover:text-red-500 bg-white border border-slate-200 rounded-lg hover:bg-red-50 transition-all"><Icons.Trash size={16}/></button></td></tr>))}</tbody></table></div>
                </div>
            </div>
        );

        const ResRekapApp = () => {
            const [viewMode, setViewMode] = useState('login'); 
            const [currentUser, setCurrentUser] = useState(null);
            const [participantSession, setParticipantSession] = useState(null);
            const [users, setUsers] = useState([]);
            const [events, setEvents] = useState([]);
            const [savedSheets, setSavedSheets] = useState([]);
            const [settings, setSettings] = useState({ organizerName: "Panitia Pelaksana", appLogo: null });
            const [dbStatus, setDbStatus] = useState('connecting');
            const [tab, setTab] = useState('dashboard');
            const [modal, setModal] = useState({ open: false });
            const [tokenModal, setTokenModal] = useState({ open: false, data: null });
            const [isFullscreen, setIsFullscreen] = useState(false);
            const [pdfData, setPdfData] = useState(null);
            const [previewData, setPreviewData] = useState(null); 
            const [isGeneratingPdf, setIsGeneratingPdf] = useState(false);

            useEffect(() => {
                if (!db) { setDbStatus('error'); return; }
                const unsubEvents = db.collection('events').onSnapshot(snapshot => { setEvents(snapshot.docs.map(doc => doc.data())); setDbStatus('connected'); }, () => setDbStatus('error'));
                const unsubUsers = db.collection('users').onSnapshot(snapshot => {
                    const loadedUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (loadedUsers.length === 0) db.collection('users').add({ username: 'Respati', password: '007' });
                    else setUsers(loadedUsers);
                });
                const unsubSheets = db.collection('saved_sheets').onSnapshot(snapshot => setSavedSheets(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                const unsubSettings = db.collection('meta').doc('settings').onSnapshot(doc => { if (doc.exists) setSettings(doc.data()); else db.collection('meta').doc('settings').set({ organizerName: "Panitia Pelaksana", appLogo: null }); });
                return () => { unsubEvents(); unsubUsers(); unsubSheets(); unsubSettings(); };
            }, []);

            const saveEvent = (eventData) => db.collection('events').doc(eventData.id).set(eventData);
            const deleteEvent = (eventId) => db.collection('events').doc(eventId).delete();
            const saveSheet = (sheetData) => db.collection('saved_sheets').add(sheetData);
            const deleteSheet = (sheetId) => db.collection('saved_sheets').doc(sheetId).delete();
            const saveSettings = (newSettings) => db.collection('meta').doc('settings').set(newSettings);
            const addNewUser = (username, password) => db.collection('users').add({ username, password });
            const removeUser = (userId) => db.collection('users').doc(userId).delete();

            const triggerModal = (title, type, cb, msg, ph, defVal = '', confirmBtnText = null) => { 
                setModal({ open: true, title, type, message: msg, placeholder: ph, defaultValue: defVal, confirmBtnText, onConfirm: (v) => { setModal(prev => ({ ...prev, open: false })); setTimeout(() => cb(v), 150); }, onCancel: () => setModal(prev => ({ ...prev, open: false })) }); 
            };
            const triggerTokenModal = (event, participant, token) => {
                 setTokenModal({ open: true, data: { event, participant, token } });
            };

            const toggleFullscreen = () => { if (!document.fullscreenElement) { document.documentElement.requestFullscreen().then(() => setIsFullscreen(true)).catch(console.error); } else { document.exitFullscreen().then(() => setIsFullscreen(false)); } };
            const handleDownloadPDF = (data, filename) => { setPdfData(data); setIsGeneratingPdf(true); setTimeout(() => { generatePDF('pdf-content', filename, () => { setIsGeneratingPdf(false); setPdfData(null); }); }, 1500); };
            const handlePreviewPDF = (data) => setPreviewData(data);
            const handleLogin = (user) => { setCurrentUser(user); setViewMode('admin'); };
            const handleLogout = () => { setViewMode('login'); setCurrentUser(null); setParticipantSession(null); };

            const checkToken = async (tokenInput) => {
                const snapshot = await db.collection('events').get();
                const allEvents = snapshot.docs.map(doc => doc.data());
                for (const ev of allEvents) {
                    const found = ev.participants.find(p => p.token === tokenInput);
                    if (found) {
                        setParticipantSession({ event: ev, participant: found });
                        setViewMode('participant');
                        return true;
                    }
                }
                return false;
            };

            const handleAddUser = () => { triggerModal("Tambah Pengguna Baru", "input", (username) => { if(!username) return alert("Wajib diisi"); if(users.some(u => u.username.toLowerCase() === username.toLowerCase())) return alert("Sudah ada"); triggerModal("Set Password", "input", (password) => { if(!password) return alert("Wajib diisi"); addNewUser(username, password); }, null, "Password..."); }, null, "Username..."); };
            const handleDeleteUser = (u) => { if(users.length <= 1) return alert("Tidak bisa menghapus user terakhir."); triggerModal("Hapus User?", "confirm", () => { removeUser(u.id); }, `Hapus akses ${u.username}?`); };

            if (viewMode === 'login') return <LoginView users={users} onLogin={handleLogin} onTokenCheck={checkToken} dbStatus={dbStatus} settings={settings} />;
            if (viewMode === 'participant' && participantSession) return <ParticipantView session={participantSession} onLogout={handleLogout} />;

            return (
                <div className="flex h-screen bg-[#f8fafc] relative">
                    <SimpleModal isOpen={modal.open} {...modal} onCancel={() => setModal({open: false})} />
                    <TokenActionModal isOpen={tokenModal.open} onClose={() => setTokenModal({open: false, data: null})} {...tokenModal.data} />
                    <PreviewModal isOpen={!!previewData} onClose={() => setPreviewData(null)}>{previewData && <PDFContent data={previewData} settings={settings} />}</PreviewModal>
                    {pdfData && <div id="pdf-fullscreen-container"><div id="pdf-content"><PDFContent data={pdfData} settings={settings} /></div></div>}
                    {isGeneratingPdf && <div id="pdf-loading-overlay"><Icons.Loader size={64} className="text-indigo-600 animate-spin mb-6"/><h2 className="text-3xl font-extrabold text-slate-900 tracking-tight">Menyusun Dokumen Digital</h2><p className="text-slate-500 mt-2 font-medium">Mohon tidak menutup aplikasi hingga proses selesai.</p></div>}

                    <aside className="w-64 bg-slate-900 text-white flex flex-col shadow-2xl z-10">
                        <div className="p-6 flex flex-col items-center justify-center mb-4 transition-all hover:bg-white/5 cursor-pointer" title="Klik untuk Fullscreen" onClick={toggleFullscreen}>
                            <div className="flex items-center gap-4 w-full">{settings.appLogo ? <img src={settings.appLogo} className="w-10 h-10 object-contain bg-white/10 rounded-xl p-1.5 border border-white/5"/> : <div className="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center font-black text-xl shadow-lg shadow-indigo-500/20">R</div>}<div><h1 className="font-extrabold text-lg tracking-tight leading-none">ResRekap</h1><p className="text-[9px] text-indigo-400 font-bold tracking-[0.2em] uppercase mt-1">v5.6 Pro Online</p></div></div>
                        </div>
                        <nav className="flex-1 px-3 space-y-1 overflow-y-auto">
                            <SidebarLink active={tab==='dashboard'} icon={<Icons.Dashboard size={18}/>} label="Dashboard" onClick={()=>setTab('dashboard')}/>
                            <SidebarLink active={tab==='events'} icon={<Icons.Event size={18}/>} label="Struktur Lomba" onClick={()=>setTab('events')}/>
                            <SidebarLink active={tab==='recap'} icon={<Icons.Recap size={18}/>} label="Rekapitulasi Nilai" onClick={()=>setTab('recap')}/>
                            <SidebarLink active={tab==='sheets'} icon={<Icons.Sheet size={18}/>} label="Lembar Penilaian" onClick={()=>setTab('sheets')}/>
                            <SidebarLink active={tab==='report'} icon={<Icons.Report size={18}/>} label="Laporan Akhir" onClick={()=>setTab('report')}/>
                            <SidebarLink active={tab==='accounts'} icon={<Icons.UserCog size={18}/>} label="Manajemen Akun" onClick={()=>setTab('accounts')}/>
                            <SidebarLink active={tab==='settings'} icon={<Icons.Settings size={18}/>} label="Konfigurasi" onClick={()=>setTab('settings')}/>
                        </nav>
                        <div className="p-6"><button onClick={handleLogout} className="w-full py-3 bg-red-500/10 hover:bg-red-500 text-red-400 hover:text-white rounded-xl font-bold text-xs flex items-center justify-center gap-2 transition-all"><Icons.LogOut size={14}/> Keluar</button><p className="text-center text-[9px] text-slate-500 font-bold tracking-widest uppercase opacity-40 mt-4">&copy; 2026 ResRekap Team</p></div>
                    </aside>

                    <main className="flex-1 overflow-auto p-10 bg-pattern">
                        <div className="max-w-7xl mx-auto">
                            {tab === 'dashboard' && <DashboardView events={events} setTab={setTab} />}
                            {tab === 'events' && <EventSettings events={events} saveEvent={saveEvent} deleteEvent={deleteEvent} modal={triggerModal} />}
                            {tab === 'recap' && <RecapView events={events} saveEvent={saveEvent} modal={triggerModal} triggerTokenModal={triggerTokenModal} />}
                            {tab === 'sheets' && <SheetGeneratorView events={events} download={handleDownloadPDF} preview={handlePreviewPDF} savedSheets={savedSheets} saveSheet={saveSheet} deleteSheet={deleteSheet} modal={triggerModal}/>} 
                            {tab === 'report' && <ReportView events={events} saveEvent={saveEvent} settings={settings} download={handleDownloadPDF} modal={triggerModal} />}
                            {tab === 'accounts' && <AccountManagerView users={users} addUser={handleAddUser} deleteUser={handleDeleteUser} />}
                            {tab === 'settings' && <AppSettings settings={settings} saveSettings={saveSettings} events={events} saveEvent={saveEvent} modal={triggerModal} />}
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ResRekapApp />);
    </script>
</body>
</html>

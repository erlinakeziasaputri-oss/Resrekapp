<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Sistem Rekapitulasi Juara Profesional - ResRekap Pro">
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ResRekap Pro - Professional Tabulation System</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèÜ</text></svg>">
    <link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiUmVzUmVrYXAgUHJvIiwic2hvcnRfbmFtZSI6IlJlc1Jla2FwIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmOGZhZmMiLCJ0aGVtZV9jb2xvciI6IiM0ZjQ2ZTUiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9jZG4uanNkZWxpdnIubmV0L2doL3R3YnMvaWNvbnNAbWFpbi9pY29ucy90cm9waHkuc3ZnIiwic2l6ZXMiOiIxOTJ4MTkyIiwidHlwZSI6ImltYWdlL3N2Zyt4bWwifV19">

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .modal-overlay { background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); }
        #pdf-fullscreen-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: #1e293b; z-index: 9000; overflow-y: auto; display: flex; justify-content: center; padding: 40px 0; align-items: flex-start; }
        #pdf-content { width: 210mm; min-height: 297mm; background: white; padding: 15mm 10mm; box-sizing: border-box; color: #0f172a; font-family: 'Times New Roman', serif; position: relative; display: flex; flex-direction: column; margin: 0 auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        #pdf-loading-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(255,255,255,0.9); z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(8px); }
        .pdf-table { width: 100%; border-collapse: collapse; font-size: 10pt; margin-bottom: 20px; }
        .pdf-table th { border: 1px solid #000; background-color: #f1f5f9; padding: 8px 6px; font-weight: bold; text-transform: uppercase; }
        .pdf-table td { border: 1px solid #000; padding: 6px; vertical-align: middle; }
        .preview-modal-content { width: 215mm; max-width: 95vw; height: 85vh; background: #334155; overflow-y: auto; border-radius: 12px; padding: 30px; display: flex; justify-content: center; }
        input[type=number] { -moz-appearance: textfield; }
        .glass-card { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .bg-pattern { background-color: #f8fafc; background-image: radial-gradient(#e2e8f0 1px, transparent 1px); background-size: 24px 24px; }
    </style>
</head>
<body class="bg-[#f8fafc] text-slate-900 h-screen overflow-hidden">
    <div id="root"></div>

    <script type="text/babel">
        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyB4xfUu83UGqMDNoECaMndBrI0MoSYgbl8",
            authDomain: "resrekap.firebaseapp.com",
            projectId: "resrekap",
            storageBucket: "resrekap.firebasestorage.app",
            messagingSenderId: "644884929137",
            appId: "1:644884929137:web:f64bb70a2a5ad18f32d9d0"
        };

        // Initialize Firebase
        let db;
        try {
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            db.enablePersistence().catch(() => {}); // Persistence might fail in some envs
        } catch (error) { console.error("Firebase Init Error:", error); }

        const { useState, useEffect, useRef } = React;
        const generateId = () => Math.random().toString(36).substr(2, 9);

        // --- ICONS HELPER ---
        const IconBridge = ({ name, size = 20, className = "", ...props }) => {
            const iconData = lucide.icons[name];
            if (!iconData) return null;
            return React.createElement('svg', { 
                ...props, width: size, height: size, viewBox: "0 0 24 24", 
                fill: "none", stroke: "currentColor", strokeWidth: 2, 
                strokeLinecap: "round", strokeLinejoin: "round", 
                className: `lucide lucide-${name} ${className}` 
            }, ...iconData.map(([tag, attrs]) => React.createElement(tag, attrs)));
        };

        const Icons = {
            Dashboard: (p) => <IconBridge name="LayoutDashboard" {...p} />,
            Event: (p) => <IconBridge name="Layers" {...p} />,
            Recap: (p) => <IconBridge name="ClipboardEdit" {...p} />,
            Report: (p) => <IconBridge name="FileBarChart" {...p} />,
            Settings: (p) => <IconBridge name="Sliders" {...p} />,
            Plus: (p) => <IconBridge name="Plus" {...p} />,
            Trash: (p) => <IconBridge name="Trash2" {...p} />,
            Edit: (p) => <IconBridge name="Pencil" {...p} />,
            Save: (p) => <IconBridge name="Save" {...p} />,
            Users: (p) => <IconBridge name="Users" {...p} />,
            Trophy: (p) => <IconBridge name="Trophy" {...p} />,
            Download: (p) => <IconBridge name="Download" {...p} />,
            Back: (p) => <IconBridge name="ChevronLeft" {...p} />,
            Check: (p) => <IconBridge name="Check" {...p} />,
            Max: (p) => <IconBridge name="Expand" {...p} />,
            Min: (p) => <IconBridge name="Shrink" {...p} />,
            Upload: (p) => <IconBridge name="UploadCloud" {...p} />,
            Image: (p) => <IconBridge name="Image" {...p} />,
            X: (p) => <IconBridge name="X" {...p} />,
            Loader: (p) => <IconBridge name="Loader2" {...p} />,
            Lock: (p) => <IconBridge name="Lock" {...p} />,
            Unlock: (p) => <IconBridge name="Unlock" {...p} />,
            ArrowUp: (p) => <IconBridge name="ArrowUp" {...p} />,
            ArrowDown: (p) => <IconBridge name="ArrowDown" {...p} />,
            Sheet: (p) => <IconBridge name="FileSpreadsheet" {...p} />,
            Eye: (p) => <IconBridge name="Eye" {...p} />, 
            Briefcase: (p) => <IconBridge name="Briefcase" {...p} />,
            UserCog: (p) => <IconBridge name="UserCog" {...p} />,
            LogOut: (p) => <IconBridge name="LogOut" {...p} />,
            Key: (p) => <IconBridge name="KeyRound" {...p} />,
            Alert: (p) => <IconBridge name="AlertTriangle" {...p} />,
            Ticket: (p) => <IconBridge name="Ticket" {...p} />,
            Search: (p) => <IconBridge name="Search" {...p} />,
            Printer: (p) => <IconBridge name="Printer" {...p} />,
        };

        // --- HELPERS ---
        const resizeImage = (file) => new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width, height = img.height;
                    if (width > 400) { height *= 400 / width; width = 400; }
                    canvas.width = width; canvas.height = height;
                    canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.92));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });

        const generateToken = () => {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let token = '';
            for (let i = 0; i < 6; i++) token += chars.charAt(Math.floor(Math.random() * chars.length));
            return token;
        };

        const generateTokenCardImage = async (event, participant, token) => {
            const scale = 3; const width = 600 * scale; const height = 350 * scale;
            const canvas = document.createElement('canvas'); canvas.width = width; canvas.height = height;
            const ctx = canvas.getContext('2d'); ctx.scale(scale, scale);

            const grd = ctx.createLinearGradient(0, 0, 600, 350); grd.addColorStop(0, "#4f46e5"); grd.addColorStop(1, "#312e81");
            ctx.fillStyle = grd; ctx.fillRect(0, 0, 600, 350);
            
            ctx.fillStyle = "rgba(255,255,255,0.05)";
            ctx.beginPath(); ctx.arc(500, -50, 150, 0, 2 * Math.PI); ctx.fill();
            ctx.beginPath(); ctx.arc(50, 400, 120, 0, 2 * Math.PI); ctx.fill();

            ctx.fillStyle = "#ffffff"; ctx.font = "bold 24px sans-serif"; ctx.fillText("KARTU AKSES NILAI", 40, 50);
            ctx.font = "16px sans-serif"; ctx.fillStyle = "rgba(255,255,255,0.8)"; ctx.fillText(event.name || "ResRekap Event", 40, 80);

            if (event.logo) {
                try {
                    const img = new Image(); img.src = event.logo;
                    await new Promise(r => { img.onload = r; img.onerror = r; });
                    const h = 60; const w = h * (img.width / img.height);
                    ctx.drawImage(img, 540 - w, 30, w, h);
                } catch (e) {}
            }

            ctx.fillStyle = "rgba(255,255,255,0.1)"; ctx.fillRect(40, 110, 520, 100);
            ctx.fillStyle = "#ffffff"; ctx.font = "bold 32px sans-serif"; ctx.fillText(participant.name, 60, 155);
            ctx.font = "18px sans-serif"; ctx.fillText(`ID Peserta: ${participant.number}`, 60, 185); 

            ctx.fillStyle = "#ffffff"; ctx.font = "bold 60px monospace"; ctx.textAlign = "center"; ctx.fillText(token, 300, 290);
            ctx.font = "italic 12px sans-serif"; ctx.fillStyle = "rgba(255,255,255,0.6)"; ctx.textAlign = "center"; ctx.fillText("Rekap oleh ResRekap", 300, 330);
            return canvas.toDataURL('image/png', 1.0);
        };

        const downloadToken = async (event, p, token) => {
             const url = await generateTokenCardImage(event, p, token);
             const link = document.createElement('a'); link.download = `Token_${p.name.replace(/\s+/g, '_')}.png`; link.href = url; link.click();
        };

        const printToken = async (event, p, token) => {
             const url = await generateTokenCardImage(event, p, token);
             const win = window.open('');
             win.document.write(`<html><body style="margin:0;display:flex;justify-content:center;align-items:center;height:100vh;"><img src="${url}" style="max-width:100%;height:auto;"/></body><script>window.onload=function(){window.print();window.close();}<\/script></html>`);
        };

        const generatePDF = (elementId, fileName, callback) => {
            const element = document.getElementById(elementId);
            if(!element) { if(callback) callback(); return; }
            window.scrollTo(0, 0);
            const opt = { margin: 0, filename: `${fileName}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true, scrollY: 0 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
            html2pdf().set(opt).from(element).save().then(() => { if(callback) callback(); }).catch(() => { if(callback) callback(); });
        };

        const RANK_PALETTE = ['bg-yellow-100 border-yellow-200', 'bg-red-50 border-red-100', 'bg-orange-100 border-orange-200', 'bg-red-100 border-red-200', 'bg-amber-100 border-amber-200', 'bg-emerald-50 border-emerald-100'];
        const RANK_PALETTE_PDF = ['#fef9c3', '#fef2f2', '#ffedd5', '#fee2e2', '#fef3c7', '#ecfdf5'];

        const getAspectScore = (p, catId, aspId, judgeCount) => {
            if (!p || !p.scores || !p.scores[catId] || !p.scores[catId][aspId]) return 0;
            const scores = p.scores[catId][aspId];
            let total = 0;
            for(let j=1; j<=judgeCount; j++) total += (parseFloat(scores[j]) || 0);
            return total / Math.max(1, judgeCount) || 0;
        };
        const getCategoryTotal = (p, cat) => {
            if (!cat || !cat.aspects) return 0;
            return cat.aspects.reduce((sum, asp) => sum + getAspectScore(p, cat.id, asp.id, cat.judgeCount), 0);
        };
        const getCustomTotal = (p, categories) => {
            if (!categories) return 0;
            return categories.reduce((sum, cat) => sum + getCategoryTotal(p, cat), 0);
        };

        // --- COMPONENTS ---
        const ModalWrapper = ({ children, isOpen, onClose }) => {
            if (!isOpen) return null;
            return ( <div className="fixed inset-0 z-[100] modal-overlay overflow-y-auto grid place-items-center p-4" onClick={onClose}> <div className="relative bg-white w-full max-w-lg rounded-[24px] shadow-2xl animate-fade-in my-8 overflow-hidden" onClick={e => e.stopPropagation()}> {children} </div> </div> );
        };
        
        const SimpleModal = ({ isOpen, title, type = 'input', message, onConfirm, onCancel, placeholder, defaultValue = '', confirmBtnText }) => {
            const [val, setVal] = useState('');
            const inputRef = useRef(null);
            
            useEffect(() => { 
                if (isOpen) { 
                    setVal(defaultValue || ''); 
                    setTimeout(() => { if (inputRef.current) inputRef.current.focus(); }, 50); 
                } 
            }, [isOpen, defaultValue]);

            const isPassword = title ? (title.toLowerCase().includes("password") || title.toLowerCase().includes("pin")) : false;
            
            if(!isOpen) return null;
            
            return (
                <ModalWrapper onClose={onCancel}>
                    <div className="p-8">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-2xl font-extrabold text-slate-900 tracking-tight">{title}</h3>
                            <button onClick={onCancel} className="text-slate-400 hover:text-slate-600 transition-colors"><Icons.X size={20}/></button>
                        </div>
                        {type === 'confirm' ? (
                            <p className="text-slate-600 mb-8 text-lg leading-relaxed font-medium">{message}</p>
                        ) : (
                            <div className="mb-8">
                                <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Input Data</label>
                                <input 
                                    ref={inputRef} 
                                    type={isPassword ? "password" : "text"} 
                                    className="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none transition-all font-medium text-slate-800" 
                                    placeholder={placeholder} 
                                    value={val} 
                                    onChange={e=>setVal(e.target.value)} 
                                    onKeyDown={e => e.key === 'Enter' && onConfirm(val)} 
                                    autoComplete="off" 
                                />
                            </div>
                        )}
                        <div className="flex justify-end gap-3">
                            <button onClick={onCancel} className="px-6 py-3 text-slate-500 hover:bg-slate-100 rounded-xl font-bold transition-all">Batal</button>
                            <button onClick={() => onConfirm(type==='input'?val:true)} className={`px-8 py-3 rounded-xl shadow-lg transition-all font-bold text-white ${type === 'confirm' ? 'bg-red-500 hover:bg-red-600 shadow-red-100' : 'bg-indigo-600 hover:bg-indigo-700 shadow-indigo-100'}`}>
                                {confirmBtnText || (type === 'confirm' ? 'Hapus' : 'Lanjutkan')}
                            </button>
                        </div>
                    </div>
                </ModalWrapper>
            );
        };

        const TokenActionModal = ({ isOpen, onClose, event, participant, token }) => {
            if(!isOpen || !event || !participant) return null;
            return (
                <ModalWrapper onClose={onClose}>
                    <div className="p-8 text-center">
                        <div className="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4"><Icons.Key size={32}/></div>
                        <h3 className="text-2xl font-black text-slate-800 mb-2">Token Akses Peserta</h3>
                        <p className="text-slate-500 mb-6 font-medium">Gunakan token ini untuk login peserta.</p>
                        <div className="bg-slate-100 p-4 rounded-xl border border-slate-200 mb-6"><p className="text-4xl font-mono font-bold text-slate-800 tracking-widest">{token}</p></div>
                        <div className="grid grid-cols-2 gap-4">
                            <button onClick={() => { downloadToken(event, participant, token); onClose(); }} className="py-3 bg-white border-2 border-slate-200 text-slate-700 hover:border-indigo-600 hover:text-indigo-600 rounded-xl font-bold flex items-center justify-center gap-2 transition-all"><Icons.Download size={18}/> Unduh</button>
                            <button onClick={() => { printToken(event, participant, token); onClose(); }} className="py-3 bg-indigo-600 text-white hover:bg-indigo-700 rounded-xl font-bold flex items-center justify-center gap-2 transition-all"><Icons.Printer size={18}/> Cetak</button>
                        </div>
                    </div>
                </ModalWrapper>
            );
        };

        const PreviewModal = ({ isOpen, onClose, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] modal-overlay flex items-center justify-center p-4">
                    <div className="relative animate-fade-in flex flex-col items-center w-full">
                        <div className="flex justify-between items-center w-full max-w-4xl px-4 mb-4 text-white">
                            <h3 className="text-xl font-bold tracking-tight">Dokumen Pratinjau</h3>
                            <button onClick={onClose} className="p-2 bg-white/10 rounded-full hover:bg-white/20 transition-all"><Icons.X /></button>
                        </div>
                        <div className="preview-modal-content shadow-2xl">
                            <div style={{background: 'white', padding: '15mm 10mm', width: '100%', minHeight: '100%'}}>{children}</div>
                        </div>
                    </div>
                </div>
            );
        };

        const SidebarLink = ({ active, icon, label, onClick }) => (
            <button onClick={onClick} className={`w-full flex items-center gap-4 px-4 py-3 rounded-2xl transition-all duration-300 font-semibold group ${active ? 'bg-white text-indigo-700 shadow-md' : 'text-slate-400 hover:bg-white/5 hover:text-white'}`}>
                <span className={`${active ? 'text-indigo-600' : 'group-hover:text-indigo-400'} transition-colors`}>{icon}</span>
                <span className="tracking-tight text-sm">{label}</span>
            </button>
        );

        // --- VIEWS ---
        const LoginView = ({ users, onLogin, onTokenCheck, dbStatus, settings, toggleFullscreen }) => {
            const [mode, setMode] = useState('admin');
            const [username, setUsername] = useState(''); const [password, setPassword] = useState(''); const [token, setToken] = useState('');
            const [error, setError] = useState(''); const [checking, setChecking] = useState(false);

            const handleAdminLogin = (e) => { e.preventDefault(); const user = users.find(u => u.username.toLowerCase() === username.toLowerCase() && u.password === password); if(user) onLogin(user); else setError('Username atau password salah'); };
            const handleTokenCheck = async (e) => { e.preventDefault(); if(!token) return setError("Masukkan token."); setChecking(true); setError(''); const res = await onTokenCheck(token.toUpperCase()); setChecking(false); if(!res) setError("Token tidak ditemukan."); };

            return (
                <div className="fixed inset-0 z-50 overflow-y-auto bg-gradient-to-br from-indigo-800 to-violet-900 bg-pattern">
                     <div className="min-h-full flex items-center justify-center p-6">
                        <div className="bg-white w-full max-w-md rounded-[40px] shadow-2xl border border-white/20 backdrop-blur-lg bg-white/95 p-10 animate-fade-in">
                            <div className="text-center mb-8">
                                <div onClick={toggleFullscreen} className="mx-auto mb-6 w-24 h-24 bg-white rounded-3xl shadow-xl flex items-center justify-center overflow-hidden border-4 border-indigo-50 cursor-pointer hover:scale-105 transition-transform">
                                    {settings && settings.appLogo ? <img src={settings.appLogo} alt="Logo" className="w-full h-full object-contain" /> : <div className="text-4xl font-black text-indigo-600">R</div>}
                                </div>
                                <h1 className="text-3xl font-black text-slate-800 tracking-tight mb-1">ResRekap</h1>
                                <p className="text-slate-500 font-medium text-sm">Professional Online System</p>
                                <p className="text-[10px] font-bold text-indigo-400 mt-2 tracking-widest uppercase">by Respati Team</p>
                                {dbStatus === 'error' && <div className="mt-6 p-3 bg-red-50 text-red-600 text-xs rounded-xl border border-red-100 flex items-center gap-2 text-left"><Icons.Alert size={16} className="shrink-0"/> Database tidak terhubung.</div>}
                            </div>
                            <div className="flex bg-slate-100 p-1.5 rounded-2xl mb-8 border border-slate-200">
                                <button onClick={()=>{setMode('admin'); setError('');}} className={`flex-1 py-2.5 text-sm font-bold rounded-xl transition-all ${mode==='admin' ? 'bg-white text-indigo-600 shadow-md ring-1 ring-slate-200' : 'text-slate-400 hover:text-slate-600'}`}>Admin</button>
                                <button onClick={()=>{setMode('participant'); setError('');}} className={`flex-1 py-2.5 text-sm font-bold rounded-xl transition-all ${mode==='participant' ? 'bg-white text-indigo-600 shadow-md ring-1 ring-slate-200' : 'text-slate-400 hover:text-slate-600'}`}>Peserta</button>
                            </div>
                            {mode === 'admin' ? (
                                <form onSubmit={handleAdminLogin} className="space-y-5">
                                    <div><label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 ml-1">Username</label><input autoFocus type="text" className="w-full pl-12 p-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none transition-all font-bold text-slate-800" placeholder="Username" value={username} onChange={e=>setUsername(e.target.value)} autoComplete="off"/></div>
                                    <div><label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 ml-1">Password</label><input type="password" className="w-full pl-12 p-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none transition-all font-bold text-slate-800" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value={password} onChange={e=>setPassword(e.target.value)} autoComplete="new-password"/></div>
                                    {error && <p className="text-red-500 text-xs font-bold text-center bg-red-50 p-3 rounded-xl border border-red-100">{error}</p>}
                                    <button type="submit" className="w-full py-4 bg-indigo-600 text-white rounded-2xl font-black shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-all transform hover:scale-[1.02]">Masuk Aplikasi</button>
                                </form>
                            ) : (
                                <form onSubmit={handleTokenCheck} className="space-y-5">
                                    <div><label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 ml-1">Token Akses</label><input autoFocus type="text" className="w-full pl-12 p-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none transition-all font-black text-slate-800 uppercase tracking-widest text-lg" placeholder="X7Y2Z1" value={token} onChange={e=>setToken(e.target.value.toUpperCase())} maxLength={6} autoComplete="off"/></div>
                                    {error && <p className="text-red-500 text-xs font-bold text-center bg-red-50 p-3 rounded-xl border border-red-100">{error}</p>}
                                    <button type="submit" disabled={checking} className="w-full py-4 bg-indigo-600 text-white rounded-2xl font-black shadow-lg shadow-indigo-200 hover:bg-indigo-700 transition-all transform hover:scale-[1.02] flex items-center justify-center gap-2">{checking ? <Icons.Loader className="animate-spin" size={18}/> : <><Icons.Search size={18}/> Cek Hasil Saya</>}</button>
                                </form>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const ParticipantView = ({ session, onLogout }) => {
            const { event, participant } = session;
            const [expandedCats, setExpandedCats] = useState({});
            const toggleCat = (catId) => setExpandedCats(prev => ({ ...prev, [catId]: !prev[catId] }));

            return (
                <div className="h-screen bg-slate-50 overflow-auto bg-pattern">
                    <div className="max-w-3xl mx-auto bg-white min-h-screen shadow-2xl border-x border-slate-100 animate-fade-in">
                        <div className="bg-indigo-600 p-10 text-white relative overflow-hidden rounded-b-[50px] shadow-lg mb-8">
                            <div className="absolute top-0 right-0 w-64 h-64 bg-white/5 rounded-full -mr-20 -mt-20"></div>
                            <div className="relative z-10">
                                <div className="flex justify-between items-start mb-6"><button onClick={onLogout} className="px-4 py-2 bg-white/20 hover:bg-white/30 text-white rounded-xl text-xs font-bold flex items-center gap-2 backdrop-blur-sm transition-all"><Icons.Back size={14}/> Cek Token Lain</button><h4 className="text-xs font-black uppercase tracking-[0.2em] opacity-60">Laporan Individu</h4></div>
                                <h1 className="text-4xl font-black mb-2 tracking-tight leading-tight">{participant.name}</h1>
                                <p className="font-bold opacity-80 mb-8 text-indigo-200">ID Peserta: <span className="text-white font-mono">{participant.number}</span></p>
                                <div className="flex flex-wrap justify-between items-end gap-4"><div className="flex items-center gap-3 text-xs font-bold uppercase tracking-widest bg-black/20 w-fit px-5 py-3 rounded-2xl backdrop-blur-sm border border-white/10"><Icons.Trophy size={16} className="text-yellow-400"/> <span>{event.name}</span></div><div className="text-right bg-white/10 px-5 py-3 rounded-2xl backdrop-blur-sm border border-white/10"><p className="text-[9px] uppercase font-black tracking-widest opacity-60 mb-1">Total Skor Akhir</p><p className="text-4xl font-black leading-none">{getCustomTotal(participant, event.categories).toFixed(2)}</p></div></div>
                            </div>
                        </div>
                        <div className="p-8 space-y-6 pb-32">
                            {(event.categories || []).map((cat) => {
                                const isExpanded = expandedCats[cat.id];
                                return (
                                    <div key={cat.id} className="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden transition-all duration-300 hover:shadow-md">
                                        <div onClick={() => toggleCat(cat.id)} className={`px-6 py-5 border-b flex justify-between items-center cursor-pointer transition-colors ${isExpanded ? 'bg-slate-50' : 'bg-white hover:bg-slate-50'}`}><div className="flex items-center gap-5"><div className={`p-2 rounded-xl bg-slate-100 text-slate-400 transition-transform duration-300 ${isExpanded ? 'rotate-180 bg-indigo-100 text-indigo-600' : ''}`}><Icons.ArrowDown size={18}/></div><h3 className="font-bold text-base text-slate-800 uppercase tracking-wide">{cat.name}</h3></div><div className="px-5 py-2 rounded-xl text-sm font-black tracking-widest uppercase bg-indigo-50 text-indigo-600 border border-indigo-100">{getCategoryTotal(participant, cat).toFixed(2)}</div></div>
                                        {isExpanded && ( <div className="animate-fade-in bg-slate-50/50"><table className="w-full text-left"><thead><tr className="text-[9px] font-bold text-slate-400 uppercase tracking-widest border-b border-slate-200"><th className="px-8 py-4 w-1/3">Aspek Penilaian</th>{Array.from({length:cat.judgeCount}).map((_,i)=><th key={i} className="px-4 py-4 text-center text-xs">Juri {i+1}</th>)}</tr></thead><tbody className="divide-y divide-slate-200">{(cat.aspects || []).map((asp) => ( <tr key={asp.id} className="hover:bg-white transition-colors"><td className="px-8 py-3 align-middle"><div className="font-bold text-slate-700 text-sm leading-tight">{asp.name}</div><div className="text-[9px] text-slate-400 font-bold mt-1 bg-white border border-slate-200 px-2 py-0.5 rounded w-fit uppercase tracking-wider">Max: {asp.maxScore}</div></td>{Array.from({length:cat.judgeCount}).map((_,i) => (<td key={i} className="px-4 py-3 text-center"><span className="font-black text-slate-600 text-base">{participant.scores?.[cat.id]?.[asp.id]?.[i+1] || '-'}</span></td>))}</tr> ))}</tbody></table></div> )}
                                    </div>
                                );
                            })}
                        </div>
                        <div className="fixed bottom-8 left-1/2 transform -translate-x-1/2 z-50"><button onClick={onLogout} className="px-10 py-4 bg-slate-900 text-white rounded-full font-bold hover:bg-indigo-600 transition-all shadow-2xl shadow-indigo-500/30 flex items-center gap-3 transform hover:scale-105"><Icons.LogOut size={18}/> Keluar Aplikasi</button></div>
                    </div>
                </div>
            );
        };

        const DashboardView = ({ events, setTab }) => (
            <div className="animate-fade-in"><header className="mb-12"><h1 className="text-4xl font-black text-slate-900 tracking-tight">Selamat Datang</h1><p className="text-slate-500 font-medium mt-1 text-sm">Gunakan navigasi untuk mengelola perlombaan hari ini.</p></header><div className="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12">{[{ label: 'Event Aktif', val: events.length, color: 'text-indigo-600', bg: 'bg-indigo-50', icon: <Icons.Briefcase size={24}/> }, { label: 'Total Mata Lomba', val: events.reduce((a,b)=>a+(b.categories?.length||0),0), color: 'text-blue-600', bg: 'bg-blue-50', icon: <Icons.Trophy size={24}/> }, { label: 'Peserta Terdaftar', val: events.reduce((a,b)=>a+(b.participants?.length||0),0), color: 'text-emerald-600', bg: 'bg-emerald-50', icon: <Icons.Users size={24}/> }].map((s, i) => (<div key={i} className="bg-white p-6 rounded-[24px] shadow-sm border border-slate-100 flex items-center gap-6 hover:shadow-xl hover:translate-y-[-2px] transition-all duration-300"><div className={`p-4 rounded-xl ${s.bg} ${s.color}`}>{s.icon}</div><div><p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">{s.label}</p><h3 className="text-3xl font-black text-slate-900 mt-1">{s.val}</h3></div></div>))}</div>{events.length > 0 ? (<div className="grid grid-cols-1 md:grid-cols-2 gap-6"><button onClick={()=>setTab('recap')} className="group p-8 bg-indigo-600 text-white rounded-[32px] hover:bg-indigo-700 transition-all shadow-xl shadow-indigo-100 flex flex-col gap-4 text-left relative overflow-hidden"><div className="absolute top-[-10px] right-[-10px] p-8 bg-white/10 rounded-full group-hover:scale-110 transition-transform opacity-30"><Icons.Recap size={100}/></div><h3 className="text-xl font-bold">Lanjutkan Rekap Nilai</h3><p className="text-indigo-100 font-medium max-w-[200px] text-sm opacity-80">Masukkan skor juri untuk peserta yang sedang tampil.</p></button><button onClick={()=>setTab('report')} className="group p-8 bg-slate-900 text-white rounded-[32px] hover:bg-slate-800 transition-all shadow-xl shadow-slate-200 flex flex-col gap-4 text-left relative overflow-hidden"><div className="absolute top-[-10px] right-[-10px] p-8 bg-white/10 rounded-full group-hover:scale-110 transition-transform opacity-30"><Icons.Report size={100}/></div><h3 className="text-xl font-bold">Unduh Laporan</h3><p className="text-slate-400 font-medium max-w-[200px] text-sm opacity-80">Dapatkan hasil juara umum dan rekap per mata lomba.</p></button></div>) : (<div className="text-center p-20 bg-white rounded-[40px] border border-slate-100 shadow-sm border-dashed"><div className="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-6"><Icons.Event size={28} className="text-slate-300"/></div><h3 className="text-xl font-bold text-slate-800">Mulai Buat Event Pertama</h3><p className="text-slate-400 mt-2 mb-8 max-w-xs mx-auto text-sm">Anda belum memiliki event terdaftar.</p><button onClick={()=>setTab('events')} className="px-8 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-100 transition-all">Buat Event Baru</button></div>)}</div>
        );

        // --- Event Settings View (Safety Fixed) ---
        const EventSettings = ({ events, saveEvent, deleteEvent, modal }) => {
            const [editData, setEditData] = useState(null);
            const [activeEventId, setActiveEventId] = useState(null);
            
            // Safety check: if events are not loaded yet, don't crash
            if (!events) return null;

            const activeEvent = events.find(e => e.id === activeEventId);
            
            const moveCategory = (catId, direction) => { 
                if (!activeEvent) return;
                const newCats = [...(activeEvent.categories || [])]; 
                const index = newCats.findIndex(c => c.id === catId); 
                if (index < 0) return; 
                if (direction === 'up' && index > 0) { [newCats[index], newCats[index - 1]] = [newCats[index - 1], newCats[index]]; } 
                else if (direction === 'down' && index < newCats.length - 1) { [newCats[index], newCats[index + 1]] = [newCats[index + 1], newCats[index]]; } 
                saveEvent({...activeEvent, categories: newCats}); 
            };
            
            const handleLogo = async (e) => { 
                if(e.target.files[0]) { 
                    try { 
                        const resized = await resizeImage(e.target.files[0]); 
                        setEditData(prev => ({ ...prev, logo: resized })); 
                    } catch(err) {} 
                } 
            };
            
            const save = () => { 
                if(!editData.name) return alert("Wajib diisi"); 
                saveEvent({ 
                    ...editData, 
                    id: editData.id || generateId(), 
                    categories: editData.categories || [], 
                    participants: editData.participants || [] 
                }); 
                setEditData(null); 
            };
            
            if(activeEventId && activeEvent) return ( 
                <div className="animate-fade-in pb-24">
                    <div className="flex items-center gap-6 mb-10">
                        <button onClick={()=>setActiveEventId(null)} className="p-3 bg-white rounded-2xl shadow-sm hover:bg-slate-50 text-slate-400 hover:text-indigo-600 border border-slate-100 transition-all"><Icons.Back size={20}/></button>
                        <div>
                            <h2 className="text-2xl font-black text-slate-900 tracking-tight leading-none">Konfigurasi Struktur</h2>
                            <p className="text-slate-500 font-medium uppercase tracking-[0.1em] text-[10px] mt-1">Sedang mengedit: <span className="text-indigo-600 font-bold">{activeEvent.name}</span></p>
                        </div>
                    </div>
                    <button onClick={() => modal("Mata Lomba Baru", "input", name => { if(name) saveEvent({...activeEvent, categories: [...(activeEvent.categories||[]), { id: generateId(), name, judgeCount: 1, locked: false, aspects: [] }]}); }, null, "Nama mata lomba...")} className="w-full py-5 mb-10 border-2 border-dashed border-indigo-200 text-indigo-600 bg-indigo-50/50 rounded-2xl hover:bg-indigo-50 hover:border-indigo-400 font-bold flex justify-center items-center transition-all group"><div className="p-2 bg-indigo-100 rounded-full mr-3 group-hover:scale-110 transition-transform"><Icons.Plus size={18}/></div> Tambahkan Cabang Mata Lomba</button>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        {(activeEvent.categories || []).map((cat, index) => ( 
                            <div key={cat.id} className="bg-white p-6 rounded-[28px] shadow-sm border border-slate-100 group">
                                <div className="flex justify-between items-start mb-6">
                                    <div className="flex items-center gap-4">
                                        <div className="flex flex-col gap-0.5">
                                            <button disabled={index === 0} onClick={() => moveCategory(cat.id, 'up')} className={`p-1 rounded-md hover:bg-slate-100 ${index===0?'text-slate-200':'text-slate-400 hover:text-indigo-500'}`}><Icons.ArrowUp size={14}/></button>
                                            <button disabled={index === (activeEvent.categories?.length || 0) - 1} onClick={() => moveCategory(cat.id, 'down')} className={`p-1 rounded-md hover:bg-slate-100 ${index===(activeEvent.categories?.length||0)-1?'text-slate-200':'text-slate-400 hover:text-indigo-500'}`}><Icons.ArrowDown size={14}/></button>
                                        </div>
                                        <div>
                                            <div className="flex items-center gap-2 group-header">
                                                <h3 className="font-black text-lg text-slate-900 tracking-tight leading-none">{cat.name}</h3>
                                                <button onClick={() => modal("Edit Mata Lomba", "input", (newName) => { if(newName) saveEvent({...activeEvent, categories: activeEvent.categories.map(c => c.id === cat.id ? {...c, name: newName} : c)}); }, null, "Nama lomba...", cat.name)} className="p-1 text-slate-300 hover:text-indigo-500 transition-all opacity-0 group-hover:opacity-100"><Icons.Edit size={12}/></button>
                                            </div>
                                            <div className="flex items-center gap-2 mt-2 bg-indigo-50 px-3 py-1 rounded-full w-fit">
                                                <Icons.Users size={10} className="text-indigo-500"/>
                                                <span className="text-[9px] font-black text-indigo-600 uppercase tracking-widest">Juri:</span>
                                                <input type="number" min="1" className="w-6 bg-transparent border-none text-[9px] font-black focus:ring-0 p-0 text-indigo-700 text-center" value={cat.judgeCount} onChange={e => { const val = e.target.value; const newValue = val === '' ? '' : parseInt(val); saveEvent({...activeEvent, categories: activeEvent.categories.map(c => c.id === cat.id ? {...c, judgeCount: newValue} : c)}); }} onBlur={() => { if(cat.judgeCount === '' || cat.judgeCount < 1) { saveEvent({...activeEvent, categories: activeEvent.categories.map(c => c.id === cat.id ? {...c, judgeCount: 1} : c)}); } }} />
                                            </div>
                                        </div>
                                    </div>
                                    <button onClick={() => modal("Hapus Cabang Lomba?", "confirm", () => saveEvent({...activeEvent, categories: activeEvent.categories.filter(c=>c.id!==cat.id)}), "Tindakan ini tidak dapat dibatalkan.")} className="p-2 text-slate-300 hover:text-red-500 transition-colors"><Icons.Trash size={16}/></button>
                                </div>
                                <div className="space-y-2 mb-6 min-h-[40px]">
                                    {(cat.aspects || []).map(asp => (
                                        <div key={asp.id} className="group/aspect flex justify-between items-center text-xs bg-slate-50 p-2.5 rounded-xl border border-slate-100 hover:border-indigo-200 hover:bg-indigo-50/20 transition-all">
                                            <div className="flex items-center gap-3"><div className="w-1.5 h-1.5 rounded-full bg-slate-300 group-hover/aspect:bg-indigo-400"></div><span className="font-bold text-slate-700 tracking-tight">{asp.name}</span></div>
                                            <div className="flex items-center gap-3">
                                                <span className="text-[9px] font-bold bg-white text-slate-400 px-2 py-0.5 rounded-full border border-slate-100 group-hover/aspect:text-indigo-600 group-hover/aspect:border-indigo-100 transition-all uppercase">MAX: {asp.maxScore}</span>
                                                <div className="flex opacity-0 group-hover/aspect:opacity-100 transition-opacity gap-0.5">
                                                    <button onClick={() => modal("Edit Aspek", "input", (newName) => { if(newName) { modal("Edit Maksimal Skor", "input", (newMax) => { const maxVal = parseInt(newMax) || 100; const newCats = [...activeEvent.categories]; const c = newCats.find(x => x.id === cat.id); c.aspects = c.aspects.map(a => a.id === asp.id ? {...a, name: newName, maxScore: maxVal} : a); saveEvent({...activeEvent, categories: newCats}); }, null, "Contoh: 100", asp.maxScore.toString()); } }, null, "Nama aspek...", asp.name)} className="p-1 text-slate-400 hover:text-indigo-600 hover:bg-white rounded-md transition-all"><Icons.Edit size={12}/></button>
                                                    <button onClick={() => saveEvent({...activeEvent, categories: activeEvent.categories.map(c => c.id===cat.id ? {...c, aspects: c.aspects.filter(a=>a.id!==asp.id)} : c)})} className="p-1 text-slate-400 hover:text-red-500 hover:bg-white rounded-md transition-all"><Icons.X size={12}/></button>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <button onClick={() => modal("Kriteria Penilaian", "input", name => { if(name) { modal("Maksimal Nilai", "input", max => { const newCats = [...activeEvent.categories]; const c = newCats.find(x => x.id === cat.id); c.aspects.push({ id: generateId(), name, maxScore: parseInt(max)||100 }); saveEvent({...activeEvent, categories: newCats}); }, null, "Contoh: 100"); }}, null, "Nama kriteria...")} className="w-full py-2.5 text-[9px] font-black uppercase tracking-[0.2em] bg-slate-50 text-slate-400 rounded-xl hover:bg-slate-100 hover:text-indigo-600 transition-all border border-slate-100 border-dashed">+ Tambah Kriteria</button>
                            </div> 
                        ))}
                    </div>
                </div> 
            );

            return (
                <div className="animate-fade-in">
                    <ModalWrapper isOpen={!!editData} onClose={()=>setEditData(null)}>
                        <div className="p-8">
                            <div className="flex justify-between items-center mb-8"><h2 className="text-2xl font-black text-slate-900 tracking-tight">{editData?.id ? 'Ubah Informasi Event' : 'Registrasi Event Baru'}</h2><button onClick={()=>setEditData(null)} className="text-slate-400 hover:text-slate-600"><Icons.X/></button></div>
                            <div className="space-y-6">
                                <div><label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Nama Perlombaan</label><input className="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none transition-all font-medium" placeholder="Nama event lomba..." value={editData?.name||''} onChange={e=>setEditData({...editData, name: e.target.value})}/></div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div><label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Tanggal Pelaksanaan</label><input type="date" className="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none transition-all font-medium" value={editData?.date||''} onChange={e=>setEditData({...editData, date: e.target.value})}/></div>
                                    <div><label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Lokasi Utama</label><input className="w-full p-4 bg-slate-50 border border-slate-200 rounded-2xl focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 outline-none transition-all font-medium" placeholder="Lokasi..." value={editData?.location||''} onChange={e=>setEditData({...editData, location: e.target.value})}/></div>
                                </div>
                                <div>
                                    <label className="block text-xs font-black text-slate-400 uppercase tracking-widest mb-2">Identitas Visual (Logo)</label>
                                    <div className="flex gap-6 items-center bg-slate-50 p-6 rounded-3xl border border-slate-200">
                                        {editData?.logo ? (<div className="relative group"><img src={editData.logo} className="w-16 h-16 object-contain border-2 border-white rounded-2xl bg-white shadow-sm"/><button onClick={()=>setEditData({...editData, logo: null})} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition shadow-lg"><Icons.X size={12}/></button></div>) : (<div className="w-16 h-16 bg-white rounded-2xl flex items-center justify-center text-slate-300 border-2 border-dashed border-slate-200 shadow-inner"><Icons.Image size={20}/></div>)}
                                        <div className="flex-1"><input type="file" id="event-logo-input" accept="image/*" className="hidden" onChange={handleLogo}/><label htmlFor="event-logo-input" className="inline-flex items-center gap-2 px-5 py-2 bg-white border border-slate-200 rounded-xl text-[10px] font-black uppercase tracking-widest hover:border-indigo-500 hover:text-indigo-600 transition-all shadow-sm cursor-pointer"><Icons.Upload size={14}/> Unggah Logo</label><p className="text-[10px] text-slate-400 mt-2 font-medium">Resolusi 1:1, Maks 1MB.</p></div>
                                    </div>
                                </div>
                            </div>
                            <div className="flex justify-end gap-3 mt-10"><button onClick={()=>setEditData(null)} className="px-6 py-3 text-slate-500 hover:bg-slate-100 rounded-xl font-bold transition-all">Batal</button><button onClick={save} className="px-10 py-3 bg-indigo-600 text-white rounded-xl shadow-lg shadow-indigo-100 hover:bg-indigo-700 font-bold transition-all">Konfirmasi Data</button></div>
                        </div>
                    </ModalWrapper>

                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-10">
                        <div><h1 className="text-3xl font-black text-slate-900 tracking-tight leading-none">Manajemen Event</h1><p className="text-slate-500 font-medium mt-2 text-sm">Kelola struktur lomba.</p></div>
                        <button onClick={()=>setEditData({})} className="px-6 py-3 bg-slate-900 text-white rounded-2xl shadow-lg shadow-slate-200 hover:bg-indigo-600 hover:shadow-indigo-100 font-bold flex items-center gap-3 transition-all text-sm"><Icons.Plus size={18}/> Daftarkan Event</button>
                    </div>

                    <div className="grid grid-cols-1 gap-4 pb-20">
                        {events.map(e => (
                            <div key={e.id} className="bg-white p-6 rounded-[28px] shadow-sm border border-slate-100 flex flex-col md:flex-row items-center justify-between group hover:border-indigo-300 hover:shadow-xl hover:shadow-indigo-500/5 transition-all duration-300">
                                <div className="flex items-center gap-8 w-full">
                                    <div className="relative">{e.logo ? <img src={e.logo} className="w-20 h-20 object-contain bg-slate-50 rounded-2xl p-1.5 border border-slate-100 group-hover:scale-105 transition-transform"/> : <div className="w-20 h-20 bg-slate-100 rounded-2xl flex items-center justify-center text-slate-300 group-hover:scale-105 transition-transform"><Icons.Image size={24}/></div>}</div>
                                    <div className="flex-1">
                                        <h3 className="text-xl font-black text-slate-900 tracking-tight group-hover:text-indigo-600 transition-colors leading-none">{e.name}</h3>
                                        <div className="flex items-center gap-4 text-[10px] font-bold text-slate-400 mt-3 uppercase tracking-[0.1em]"><span className="flex items-center gap-1.5"><Icons.Event size={12} className="text-indigo-400"/> {e.date || 'Tgl N/A'}</span><span className="w-1 h-1 rounded-full bg-slate-200"></span><span className="flex items-center gap-1.5"><Icons.Users size={12} className="text-indigo-400"/> {e.location || 'Lokasi N/A'}</span></div>
                                        <div className="flex items-center gap-2 mt-4"><span className="text-[9px] font-black bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full uppercase tracking-widest">{(e.categories||[]).length} Cabang</span><span className="text-[9px] font-black bg-emerald-50 text-emerald-600 px-3 py-1 rounded-full uppercase tracking-widest">{(e.participants||[]).length} Peserta</span></div>
                                    </div>
                                </div>
                                <div className="flex gap-2 mt-6 md:mt-0 w-full md:w-auto opacity-0 group-hover:opacity-100 transition-all translate-x-2 group-hover:translate-x-0">
                                    <button onClick={()=>setActiveEventId(e.id)} className="px-5 py-2.5 bg-slate-900 text-white rounded-xl text-xs font-bold shadow-lg hover:bg-indigo-600 transition-all flex items-center gap-2 whitespace-nowrap"><Icons.Settings size={14}/> Struktur</button>
                                    <button onClick={()=>setEditData(e)} className="p-2.5 text-slate-400 hover:text-indigo-600 bg-slate-50 rounded-xl hover:bg-indigo-50 transition-all"><Icons.Edit size={16}/></button>
                                    <button onClick={() => modal("Hapus Event?", "confirm", () => deleteEvent(e.id), "Semua data nilai akan hilang selamanya.")} className="p-2.5 text-slate-400 hover:text-red-500 bg-slate-50 rounded-xl hover:bg-red-50 transition-all"><Icons.Trash size={16}/></button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div> 
            );
        };

        const RecapView = ({ events, saveEvent, modal, triggerTokenModal }) => {
            const [evtId, setEvtId] = useState(''); const [selectedPid, setSelectedPid] = useState(null); const [expandedCats, setExpandedCats] = useState({});
            const evt = events.find(e => e.id === evtId);
            useEffect(() => { if (!evtId && events.length > 0) setEvtId(events[0].id); }, [events]);
            
            const handleScore = (pid, catId, aspId, jIdx, val, maxScore) => { 
                if (val === '') { saveEvent({...evt, participants: evt.participants.map(p => p.id === pid ? {...p, scores: {...p.scores, [catId]: {...p.scores?.[catId], [aspId]: {...p.scores?.[catId]?.[aspId], [jIdx]: ''}}}} : p)}); return; }
                const numVal = parseFloat(val); let finalVal = val;
                if (!isNaN(numVal) && numVal > maxScore) { alert(`Skor maksimal adalah ${maxScore}!`); finalVal = 0; }
                saveEvent({...evt, participants: evt.participants.map(p => p.id === pid ? {...p, scores: {...p.scores, [catId]: {...p.scores?.[catId], [aspId]: {...p.scores?.[catId]?.[aspId], [jIdx]: parseFloat(finalVal) || 0}}}} : p)}); 
            };
            const handleToggleLock = (catId, currentStatus) => { if (currentStatus) { modal("Masukkan PIN Otorisasi", "input", (password) => { if(password === "0716307164") { saveEvent({...evt, categories: evt.categories.map(c => c.id === catId ? {...c, locked: false} : c)}); } else { alert("PIN Salah."); } }, null, "Masukkan PIN..."); } else { saveEvent({...evt, categories: evt.categories.map(c => c.id === catId ? {...c, locked: true} : c)}); } };
            const handleReleaseToken = (p) => { if(p.token) triggerTokenModal(evt, p, p.token); else { const newToken = generateToken(); saveEvent({ ...evt, participants: evt.participants.map(x => x.id === p.id ? {...x, token: newToken} : x) }); setTimeout(() => triggerTokenModal(evt, p, newToken), 500); } };
            const getCompletion = (p, cat) => { let total = 0; let filled = 0; (cat.aspects||[]).forEach(asp => { for(let i=1; i<=cat.judgeCount; i++) { total++; if (p.scores?.[cat.id]?.[asp.id]?.[i] !== undefined && p.scores?.[cat.id]?.[asp.id]?.[i] !== '') filled++; } }); return total === 0 ? 0 : Math.round((filled / total) * 100); };
            if(!evt && events.length > 0) return <div className="p-20 text-center"><Icons.Loader className="animate-spin mx-auto text-indigo-600" size={48}/><p className="mt-4 text-slate-400 font-bold uppercase tracking-widest">Sinkronisasi Basis Data...</p></div>;
            if(!evt) return <div className="text-center p-20 glass-card rounded-[40px] text-slate-300 font-bold uppercase tracking-widest border border-slate-100">Buat event di menu Struktur.</div>;
            if(selectedPid) {
                const p = evt.participants.find(x => x.id === selectedPid);
                return ( <div className="animate-fade-in pb-20"><div className="sticky top-0 bg-white/90 backdrop-blur-md z-30 py-3 mb-6 border-b border-slate-200 flex justify-between items-center -mx-10 px-10 shadow-sm transition-all"><div className="flex items-center gap-4"><button onClick={()=>setSelectedPid(null)} className="p-2 hover:bg-slate-100 rounded-lg transition-all border border-slate-200 text-slate-500 hover:text-indigo-600"><Icons.Back size={18}/></button><div><div className="flex items-center gap-3"><h2 className="text-xl font-black text-slate-800 tracking-tight leading-none">{p.name}</h2><button onClick={() => handleReleaseToken(p)} className="p-1.5 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-600 hover:text-white transition-all shadow-sm"><Icons.Key size={14}/></button></div><p className="text-[10px] font-bold text-indigo-600 mt-1 uppercase tracking-wider">ID: {p.number}</p></div></div><div className="text-right"><p className="text-[9px] text-slate-400 uppercase font-bold tracking-widest">Total Skor</p><p className="text-3xl font-black text-indigo-600 leading-none">{getCustomTotal(p, evt.categories).toFixed(2)}</p></div></div><div className="space-y-4 max-w-6xl mx-auto">{(evt.categories||[]).map((cat) => { const isExpanded = expandedCats[cat.id]; const completion = getCompletion(p, cat); return ( <div key={cat.id} className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden transition-all duration-300"><div onClick={() => setExpandedCats(prev => ({...prev, [cat.id]: !prev[cat.id]}))} className={`px-4 py-3 border-b flex justify-between items-center cursor-pointer hover:bg-slate-50 ${cat.locked ? 'bg-red-50/30' : 'bg-white'}`}><div className="flex items-center gap-4 flex-1"><div className={`p-1.5 rounded-full bg-slate-100 text-slate-400 transition-transform duration-300 ${isExpanded ? 'rotate-180 bg-indigo-50 text-indigo-500' : ''}`}><Icons.ArrowDown size={14}/></div><div className="flex flex-col gap-1 w-full max-w-md"><h3 className="font-bold text-sm text-slate-700 uppercase">{cat.name}{cat.locked && <Icons.Lock size={12} className="ml-2 text-red-400 inline"/>}</h3><div className="flex items-center gap-3 w-full"><div className="flex-1 h-1.5 bg-slate-100 rounded-full overflow-hidden"><div className={`h-full rounded-full transition-all duration-500 ${completion === 100 ? 'bg-emerald-500' : 'bg-indigo-500'}`} style={{width: `${completion}%`}}></div></div><span className="text-[9px] font-bold">{completion}%</span></div></div></div><div className="flex items-center gap-3" onClick={e => e.stopPropagation()}><button onClick={() => handleToggleLock(cat.id, cat.locked)} className="p-1.5 rounded-lg border border-slate-200 text-slate-400 hover:text-indigo-600"><Icons.Lock size={14}/></button><div className="px-4 py-1.5 rounded-xl text-xs font-black uppercase bg-indigo-50 text-indigo-600 border border-indigo-100 min-w-[80px] text-center">{getCategoryTotal(p, cat).toFixed(2)}</div></div></div>{isExpanded && ( <div className="bg-slate-50/30"><table className="w-full text-left"><thead><tr className="text-[9px] font-bold text-slate-400 uppercase tracking-widest border-b border-slate-100"><th className="px-6 py-3 w-1/3">Aspek Penilaian</th>{Array.from({length:cat.judgeCount}).map((_,i)=><th key={i} className="px-2 py-3 text-center">Juri {i+1}</th>)}</tr></thead><tbody className="divide-y divide-slate-100">{(cat.aspects||[]).map((asp, aspIdx) => (<tr key={asp.id} className="hover:bg-white transition-colors"><td className="px-6 py-2 align-middle"><div className="font-bold text-slate-700 text-xs">{asp.name}</div><div className="text-[9px] text-slate-400 font-bold mt-1 bg-white border border-slate-200 px-2 py-0.5 rounded w-fit">Max: {asp.maxScore}</div></td>{Array.from({length:cat.judgeCount}).map((_,i) => (<td key={i} className="px-2 py-2 text-center"><input type="number" className="w-16 p-2 text-center rounded-lg font-bold text-sm outline-none border border-slate-200 focus:border-indigo-500" value={p.scores?.[cat.id]?.[asp.id]?.[i+1] ?? ''} onChange={e => handleScore(p.id, cat.id, asp.id, i+1, e.target.value, asp.maxScore)} onFocus={(e) => e.target.select()} onWheel={(e) => e.target.blur()} placeholder="-" disabled={cat.locked} /></td>))}</tr>))}</tbody></table></div> )}</div> ); })}</div></div> );
            }
            return ( <div className="animate-fade-in"><div className="flex flex-col md:flex-row justify-between items-center gap-6 mb-10 bg-white p-5 rounded-[28px] shadow-sm border border-slate-100"><div className="flex-1 w-full"><label className="block text-[9px] font-black text-slate-400 uppercase tracking-[0.2em] mb-2 ml-1">Event Sumber Data</label><select className="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 font-bold text-slate-800 text-sm outline-none transition-all cursor-pointer" value={evtId} onChange={e=>setEvtId(e.target.value)}>{events.map(e=><option key={e.id} value={e.id}>{e.name}</option>)}</select></div><button onClick={() => modal("Registrasi Peserta", "input", num => { if(num && !(evt.participants||[]).some(p=>p.number===num)) { modal("Nama Peserta", "input", name => { if(name) saveEvent({...evt, participants: [...(evt.participants||[]), { id: generateId(), number: num, name, scores: {} }]}); }, null, "Contoh: Regu Elang") } else alert("Nomor tidak valid"); }, null, "Contoh: 001")} className="px-6 py-3 bg-indigo-600 text-white rounded-xl font-black shadow-lg shadow-indigo-100 hover:bg-indigo-700 whitespace-nowrap transition-all flex items-center gap-3 text-sm"><Icons.Plus size={18}/> Registrasi Peserta</button></div><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-20">{(evt.participants||[]).map(p => (<div key={p.id} onClick={()=>setSelectedPid(p.id)} className="bg-white p-6 rounded-[28px] border border-slate-100 shadow-sm hover:shadow-xl hover:translate-y-[-2px] cursor-pointer transition-all duration-300 group relative overflow-hidden"><div className="absolute top-0 right-0 w-20 h-20 bg-indigo-50 rounded-bl-[80px] -mr-8 -mt-8 group-hover:scale-110 transition-transform opacity-50"></div><div className="flex justify-between items-start mb-4 relative z-10"><span className="font-black text-[9px] text-indigo-600 bg-indigo-50 px-3 py-1 rounded-full tracking-widest uppercase">#{p.number}</span><button onClick={(e)=>{e.stopPropagation(); modal("Diskualifikasi Peserta?", "confirm", ()=>saveEvent({...evt, participants: evt.participants.filter(x=>x.id!==p.id)}), "Hapus data nilai peserta ini?");}} className="text-slate-200 hover:text-red-500 p-2 transition-colors"><Icons.Trash size={16}/></button></div><h3 className="text-lg font-black text-slate-900 mb-2 group-hover:text-indigo-600 transition-colors tracking-tight leading-none truncate">{p.name}</h3><div className="flex flex-col gap-1 mt-4"><p className="text-[9px] text-slate-400 font-black uppercase tracking-widest">Total Skor</p><p className="text-3xl font-black text-slate-800">{getCustomTotal(p, evt.categories).toFixed(2)}</p></div></div>))}</div></div> );
        };

        const SheetGeneratorView = ({ events, download, preview, savedSheets, saveSheet, deleteSheet, modal }) => {
            const [evtId, setEvtId] = useState(''); const [catId, setCatId] = useState(''); const [judgeNum, setJudgeNum] = useState(1); const [inputType, setInputType] = useState('manual'); const [customOptions, setCustomOptions] = useState('10,20,30,40,50');
            const evt = events.find(e => e.id === evtId); const cat = evt?.categories.find(c => c.id === catId);
            useEffect(() => { if (!evtId && events.length > 0) setEvtId(events[0].id); }, [events]);
            useEffect(() => { if(evt && evt.categories.length > 0) setCatId(evt.categories[0].id); }, [evt]);
            const handleSave = () => { if(!evt || !cat) return; saveSheet({ evtId, catId, judgeNum, inputType, options: inputType === 'choice' ? customOptions.split(',').map(s=>s.trim()) : [], title: `${cat.name} - Juri ${judgeNum}`, timestamp: new Date().toLocaleString() }); };
            const getSheetData = (sheet) => { const sEvt = events.find(e => e.id === sheet.evtId); const sCat = sEvt?.categories.find(c => c.id === sheet.catId); if (!sEvt || !sCat) return null; return { event: sEvt, type: 'assessment_sheet', category: sCat, judgeNum: sheet.judgeNum, inputType: sheet.inputType, options: sheet.options }; };
            const handleDownloadAll = async () => { if (savedSheets.length === 0) return; if (!confirm(`Cetak ${savedSheets.length} dokumen secara massal?`)) return; for (let i = 0; i < savedSheets.length; i++) { const sheet = savedSheets[i]; const data = getSheetData(sheet); if (data) { await download(data, `Sheet_${data.category.name}_Juri${sheet.judgeNum}`); await new Promise(r => setTimeout(r, 600)); } } };
            if(!evt) return <div className="text-center p-20 glass-card rounded-[40px] text-slate-300 font-bold uppercase tracking-widest border border-slate-100">Pilih atau buat event terlebih dahulu.</div>;
            return ( <div className="animate-fade-in max-w-5xl mx-auto pb-20"><header className="mb-10"><h1 className="text-3xl font-black text-slate-900 tracking-tight leading-none">Dokumen Penjurian</h1><p className="text-slate-500 font-medium mt-2 text-sm">Cetak lembar penilaian fisik untuk dewan juri.</p></header><div className="bg-white p-8 rounded-[32px] shadow-sm border border-slate-100 space-y-8 mb-10"><div className="grid grid-cols-1 md:grid-cols-2 gap-8"><div className="space-y-4"><label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Event Utama</label><select className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-800 text-sm outline-none transition-all cursor-pointer" value={evtId} onChange={e=>setEvtId(e.target.value)}>{events.map(e=><option key={e.id} value={e.id}>{e.name}</option>)}</select></div><div className="space-y-4"><label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Cabang Lomba</label><select className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-800 text-sm outline-none transition-all cursor-pointer" value={catId} onChange={e=>setCatId(e.target.value)}>{(evt?.categories||[]).map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</select></div></div>{cat && (<div className="space-y-4"><label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Identitas Juri</label><div className="flex flex-wrap gap-2">{Array.from({length: cat.judgeCount}).map((_, i) => (<button key={i} onClick={()=>setJudgeNum(i+1)} className={`px-4 py-2 rounded-xl border-2 font-black transition-all text-[10px] tracking-widest uppercase ${judgeNum===i+1 ? 'bg-indigo-600 text-white border-indigo-600 shadow-md' : 'bg-white text-slate-400 border-slate-100 hover:border-indigo-200'}`}>Juri {i+1}</button>))}</div></div>)}<div className="border-t border-slate-50 pt-8"><label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1 mb-4">Format Nilai PDF</label><div className="flex flex-col md:flex-row gap-4 mb-6"><button onClick={()=>setInputType('manual')} className={`flex-1 p-4 rounded-2xl border-2 transition-all text-left group ${inputType==='manual' ? 'border-indigo-600 bg-indigo-50/20' : 'border-slate-100 bg-white hover:border-slate-200'}`}><h4 className={`font-black text-sm tracking-tight ${inputType==='manual' ? 'text-indigo-700' : 'text-slate-800'}`}>Input Manual</h4><p className="text-[9px] text-slate-400 font-medium uppercase mt-1 tracking-widest">Kolom nilai kosong</p></button><button onClick={()=>setInputType('choice')} className={`flex-1 p-4 rounded-2xl border-2 transition-all text-left group ${inputType==='choice' ? 'border-indigo-600 bg-indigo-50/20' : 'border-slate-100 bg-white hover:border-slate-200'}`}><h4 className={`font-black text-sm tracking-tight ${inputType==='choice' ? 'text-indigo-700' : 'text-slate-800'}`}>Pilihan Ganda</h4><p className="text-[9px] text-slate-400 font-medium uppercase mt-1 tracking-widest">Opsi nilai instan</p></button></div></div><button onClick={handleSave} className="w-full py-4 bg-slate-900 text-white rounded-2xl font-black shadow-lg shadow-slate-200 hover:bg-indigo-600 transition-all text-sm">Simpan ke Antrean Cetak</button></div><div className="space-y-6"><div className="flex justify-between items-center mb-4 px-2"><h3 className="text-xl font-black text-slate-900 tracking-tight leading-none">Antrean Dokumen</h3>{savedSheets.length > 0 && (<button onClick={async () => { for (const s of savedSheets) { const d = getSheetData(s); if (d) { await download(d, `Sheet_${d.category.name}_Juri${s.judgeNum}`); await new Promise(r => setTimeout(r, 600)); } } }} className="px-4 py-2 bg-emerald-600 text-white rounded-xl font-bold shadow-lg text-[10px] tracking-widest uppercase"><Icons.Download size={14}/> Cetak Semua</button>)}</div><div className="grid grid-cols-1 md:grid-cols-2 gap-4">{savedSheets.map(sheet => (<div key={sheet.id} className="bg-white p-4 rounded-[20px] border border-slate-100 shadow-sm flex justify-between items-center group hover:border-indigo-200 transition-all"><div className="flex items-center gap-4"><div className="p-2 bg-slate-50 rounded-lg text-slate-400 group-hover:bg-indigo-50 group-hover:text-indigo-500 transition-colors"><Icons.Sheet size={20}/></div><div><h4 className="font-bold text-sm text-slate-800 group-hover:text-indigo-700 transition-colors leading-none tracking-tight">{sheet.title}</h4><p className="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-1.5">{sheet.timestamp}</p></div></div><div className="flex gap-1.5"><button onClick={() => preview(getSheetData(sheet))} className="p-2 bg-slate-50 text-slate-400 rounded-lg hover:bg-indigo-600 hover:text-white shadow-sm"><Icons.Eye size={16}/></button><button onClick={() => download(getSheetData(sheet), `Sheet_${sheet.title}`)} className="p-2 bg-slate-50 text-slate-400 rounded-lg hover:bg-indigo-600 hover:text-white shadow-sm"><Icons.Download size={16}/></button><button onClick={() => deleteSheet(sheet.id)} className="p-2 bg-slate-50 text-slate-400 hover:text-red-500 rounded-lg hover:bg-red-50"><Icons.Trash size={16}/></button></div></div>))}</div></div></div> );
        };

        const ReportView = ({ events, saveEvent, settings, download, modal }) => {
            const [evtId, setEvtId] = useState(''); 
            const evt = events.find(e => e.id === evtId);
            useEffect(() => { if (!evtId && events.length > 0) setEvtId(events[0].id); }, [events]);
            
            const getSortedParticipants = (participants, sectionKey, getScoreFn) => { return [...participants].sort((a, b) => { const scoreA = getScoreFn(a); const scoreB = getScoreFn(b); if (Math.abs(scoreA - scoreB) > 0.0001) return scoreB - scoreA; const priorityA = evt?.tieBreakers?.[sectionKey]?.[a.id] || 0; const priorityB = evt?.tieBreakers?.[sectionKey]?.[b.id] || 0; return priorityB - priorityA; }); };
            const handleTieBreak = (sectionKey, participantId, direction, getScoreFn) => { const allParticipants = [...evt.participants]; const targetParticipant = allParticipants.find(p => p.id === participantId); if (!targetParticipant) return; const targetScore = getScoreFn(targetParticipant); const tiedParticipants = allParticipants.filter(p => Math.abs(getScoreFn(p) - targetScore) < 0.0001); if (tiedParticipants.length < 2) return; const sectionBreakers = evt.tieBreakers?.[sectionKey] || {}; tiedParticipants.sort((a, b) => (sectionBreakers[b.id] || 0) - (sectionBreakers[a.id] || 0)); const currentIndex = tiedParticipants.findIndex(p => p.id === participantId); let swapIndex = -1; if (direction === 'up' && currentIndex > 0) swapIndex = currentIndex - 1; else if (direction === 'down' && currentIndex < tiedParticipants.length - 1) swapIndex = currentIndex + 1; if (swapIndex !== -1) { const temp = tiedParticipants[currentIndex]; tiedParticipants[currentIndex] = tiedParticipants[swapIndex]; tiedParticipants[swapIndex] = temp; const newSectionBreakers = { ...sectionBreakers }; tiedParticipants.forEach((p, idx) => { newSectionBreakers[p.id] = tiedParticipants.length - idx; }); saveEvent({ ...evt, tieBreakers: { ...evt.tieBreakers, [sectionKey]: newSectionBreakers } }); } };
            const doDownload = (type, idOrConfig, title) => { const data = { event: evt, type, title }; if (type === 'category') data.categoryId = idOrConfig; if (type === 'overall') data.selectedCats = evt.categories.map(c=>c.id); download(data, `${title.replace(/\s+/g, '_')}_${evt.name.replace(/\s+/g, '_')}`); };
            if(!evt) return null;
            const TableHeaderConfig = ({ sectionId, title, onDownload }) => ( <div className="px-6 py-4 bg-slate-900 text-white font-black flex flex-col md:flex-row items-center justify-between gap-4 uppercase tracking-widest text-[10px]"> <div className="flex items-center gap-3"><Icons.Trophy size={16} className="text-yellow-400"/> {title}</div> <div className="flex items-center gap-4"> <div className="flex items-center bg-white/10 px-3 py-1.5 rounded-lg border border-white/5"> <span className="mr-2 text-white/50">Juara:</span> <input type="number" min="0" className="w-10 bg-transparent text-white font-black outline-none border-b border-white/30 focus:border-indigo-400 text-center" value={evt.reportConfigs?.[sectionId] ?? 3} onChange={e => saveEvent({...evt, reportConfigs: {...evt.reportConfigs, [sectionId]: parseInt(e.target.value)||0}})} onFocus={e => e.target.select()} /> </div> <button onClick={onDownload} className="px-3 py-1.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-all flex items-center gap-1.5"><Icons.Download size={12}/> PDF</button> </div> </div> );
            const renderParticipantsTable = (participants, sectionId, getScoreFn, columns = []) => { const sorted = getSortedParticipants(participants, sectionId, getScoreFn); const winnerCount = evt.reportConfigs?.[sectionId] ?? 3; return ( <div className="overflow-x-auto"><table className="w-full text-sm text-left"><thead className="bg-slate-50 text-[9px] font-black text-slate-400 uppercase tracking-widest"><tr><th className="px-3 py-2 w-12 text-center">Rank</th><th className="px-3 py-2">Peserta</th>{columns.map((c, idx) => <th key={idx} className="px-2 py-2 text-center text-[10px]">{c.name}</th>)}<th className="px-3 py-2 text-right">Skor Akhir</th></tr></thead><tbody className="divide-y divide-slate-50">{sorted.map((p, i) => { const score = getScoreFn(p); const nextP = i < sorted.length - 1 ? sorted[i+1] : null; const prevP = i > 0 ? sorted[i-1] : null; const hasTie = (nextP && Math.abs(score - getScoreFn(nextP)) < 0.0001) || (prevP && Math.abs(score - getScoreFn(prevP)) < 0.0001); const rankClass = (i < winnerCount) ? (RANK_PALETTE[i] || 'bg-slate-50 border-slate-100') : ''; return ( <tr key={p.id} className={`${rankClass} transition-colors border-l-4 ${i < winnerCount ? 'border-l-indigo-500' : 'border-l-transparent'}`}><td className="px-3 py-2 text-center font-black text-slate-400 text-xs">{i+1}</td><td className="px-3 py-2 font-black text-slate-800 tracking-tight text-xs">{p.name} <span className="font-bold text-slate-300 text-[8px] ml-1 tracking-widest uppercase">#{p.number}</span></td>{columns.map((col, idx) => ( <td key={idx} className="px-2 py-2 text-center font-bold text-slate-500 text-xs">{col.val(p).toFixed(2)}</td> ))}<td className="px-3 py-2 text-right"><div className="flex items-center justify-end gap-2">{hasTie && (<div className="flex flex-col gap-0.5 opacity-60 hover:opacity-100 transition-opacity"><button onClick={() => handleTieBreak(sectionId, p.id, 'up', getScoreFn)} disabled={!prevP || Math.abs(getScoreFn(prevP) - score) > 0.0001} className="p-0.5 hover:text-indigo-600 disabled:opacity-20"><Icons.ArrowUp size={10}/></button><button onClick={() => handleTieBreak(sectionId, p.id, 'down', getScoreFn)} disabled={!nextP || Math.abs(getScoreFn(nextP) - score) > 0.0001} className="p-0.5 hover:text-indigo-600 disabled:opacity-20"><Icons.ArrowDown size={10}/></button></div>)}<span className="font-black text-indigo-600 text-sm">{score.toFixed(2)}</span></div></td></tr> ); })}</tbody></table></div> ); };
            return ( <div className="animate-fade-in max-w-6xl mx-auto pb-20">
                <div className="bg-white p-6 rounded-[32px] shadow-sm border border-slate-100 mb-10 sticky top-0 z-20 flex flex-col md:flex-row justify-between items-center gap-6"><div className="flex-1 w-full"><h2 className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] mb-2 ml-1">Event Sumber Data</h2><select className="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 font-bold text-slate-800 text-sm outline-none transition-all" value={evtId} onChange={e=>setEvtId(e.target.value)}>{events.map(e=><option key={e.id} value={e.id}>{e.name}</option>)}</select></div><button onClick={()=>doDownload('overall', null, 'Rekap_Lengkap')} className="px-5 py-3 bg-indigo-600 text-white rounded-xl font-black text-[10px] tracking-widest uppercase shadow-lg shadow-indigo-100 hover:bg-indigo-700 transition-all flex items-center gap-2"><Icons.Download size={14}/> Unduh Semua Laporan</button></div>
                <div className="space-y-12">
                    <div className="bg-white rounded-[32px] shadow-sm border border-slate-100 overflow-hidden"><TableHeaderConfig sectionId="overall" title="Klasemen Juara Umum" onDownload={() => doDownload('overall', null, 'Juara_Umum')} />{renderParticipantsTable(evt.participants, 'overall', (p) => getCustomTotal(p, evt.categories), evt.categories.map(c => ({ name: c.name, val: (p) => getCategoryTotal(p, c) })))}</div>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">{evt.categories.map(cat => (<div key={cat.id} className="bg-white rounded-[24px] shadow-sm border border-slate-100 overflow-hidden"><div className="px-5 py-4 bg-slate-50 text-slate-800 font-black border-b border-slate-100 flex items-center justify-between text-[9px] uppercase tracking-widest"><div className="flex items-center gap-4"><span>{cat.name}</span><div className="flex items-center bg-white border px-2 py-1 rounded"><span className="mr-1 text-slate-400">Juara:</span><input type="number" className="w-8 bg-transparent text-indigo-600 font-black outline-none" value={evt.reportConfigs?.[cat.id] ?? 3} onChange={e => saveEvent({...evt, reportConfigs: {...evt.reportConfigs, [cat.id]: parseInt(e.target.value)||0}})} onFocus={e => e.target.select()} /></div></div><button onClick={() => doDownload('category', cat.id, cat.name)} className="p-1.5 hover:text-indigo-600 transition-colors"><Icons.Download size={14}/></button></div>{renderParticipantsTable(evt.participants, cat.id, (p) => getCategoryTotal(p, cat))}</div>))}</div>
                </div>
            </div> );
        };

        const AppSettings = ({ settings, saveSettings, events, saveEvent, modal }) => {
            const handleLogo = async (e) => { if(e.target.files[0]) { try { const resized = await resizeImage(e.target.files[0], 120); saveSettings({ ...settings, appLogo: resized }); } catch(err) {} } };
            const handleExport = () => { const data = { version: "5.6", timestamp: new Date().toISOString(), events, settings }; const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `ResRekap_Backup_${new Date().toISOString().split('T')[0]}.json`; a.click(); };
            const handleImport = (e) => { const file = e.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = (ev) => { try { const data = JSON.parse(ev.target.result); if(!data.events || !data.settings) throw new Error(); modal("Sinkronisasi Data", "confirm", () => { saveSettings(data.settings); data.events.forEach(ev => saveEvent(ev)); alert("Berhasil Sinkron!"); }, "Timpa data cloud saat ini?"); } catch(err) {} e.target.value = ''; }; reader.readAsText(file); };
            return ( <div className="animate-fade-in max-w-4xl mx-auto space-y-10 pb-20"><header><h1 className="text-3xl font-black text-slate-900 tracking-tight leading-none">Konfigurasi Sistem</h1><p className="text-slate-500 font-medium mt-2 text-sm">Kelola identitas dan database.</p></header><div className="bg-white p-8 rounded-[32px] shadow-sm border border-slate-100 space-y-10"><div className="space-y-6"><h3 className="text-lg font-extrabold text-slate-800 tracking-tight flex items-center gap-3"><Icons.Image size={20} className="text-indigo-600"/> Identitas Penyelenggara</h3><div className="space-y-4"><label className="block text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">Nama Instansi / Panitia (Muncul di Header PDF)</label><input className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold text-slate-800 text-sm outline-none focus:ring-4 ring-indigo-500/10 focus:border-indigo-500 transition-all shadow-inner" value={settings.organizerName} onChange={e=>saveSettings({...settings, organizerName: e.target.value})} placeholder="Kwartir Daerah..."/></div><div className="space-y-4"><label className="block text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">Logo Utama Aplikasi</label><div className="flex items-center gap-6 p-5 bg-slate-50 border border-slate-100 rounded-2xl">{settings.appLogo ? (<div className="relative group"><img src={settings.appLogo} className="w-16 h-16 object-contain border-4 border-white rounded-xl bg-white shadow-sm"/><button onClick={()=>saveSettings({...settings, appLogo: null})} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 shadow-lg opacity-0 group-hover:opacity-100 transition-all"><Icons.X size={10}/></button></div>) : (<div className="w-16 h-16 bg-white rounded-xl flex items-center justify-center text-slate-300 border-2 border-dashed border-slate-200 shadow-inner"><Icons.Image size={24}/></div>)}<div className="flex-1"><input type="file" id="app-logo-upload" accept="image/*" onChange={handleLogo} className="hidden"/><label htmlFor="app-logo-upload" className="inline-flex items-center gap-2 px-5 py-2 bg-white border border-slate-200 rounded-xl text-[9px] font-black uppercase tracking-widest hover:border-indigo-500 transition-all shadow-sm cursor-pointer"><Icons.Upload size={14}/> Unggah Logo</label></div></div></div></div><div className="pt-8 border-t border-slate-50 space-y-6"><h3 className="text-lg font-extrabold text-slate-800 tracking-tight flex items-center gap-3"><Icons.Save size={20} className="text-indigo-600"/> Basis Data (JSON)</h3><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><button onClick={handleExport} className="group p-5 bg-slate-50 border border-slate-100 rounded-2xl hover:bg-white hover:border-indigo-200 transition-all text-left"><h4 className="font-black text-sm text-slate-800 tracking-tight">Unduh Backup</h4><p className="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-1">Ekspor seluruh data ke file JSON</p></button><label className="group p-5 bg-slate-50 border border-slate-100 rounded-2xl hover:bg-white hover:border-indigo-200 transition-all text-left cursor-pointer"><h4 className="font-black text-sm text-slate-800 tracking-tight">Impor Data</h4><p className="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-1">Pulihkan data dari file .json</p><input type="file" accept=".json" className="hidden" onChange={handleImport}/></label></div></div></div></div> );
        };

        const AccountManagerView = ({ users, addUser, deleteUser }) => (
            <div className="animate-fade-in max-w-4xl mx-auto pb-20">
                <header className="mb-10"><h1 className="text-3xl font-black text-slate-900 tracking-tight leading-none">Manajemen Akun</h1><p className="text-slate-500 font-medium mt-2 text-sm">Kelola akses pengguna aplikasi (Online Sync).</p></header>
                <div className="bg-white p-8 rounded-[32px] shadow-sm border border-slate-100">
                    <div className="flex justify-between items-center mb-8"><h3 className="text-xl font-black text-slate-800 flex items-center gap-3"><Icons.Users size={24} className="text-indigo-600"/> Daftar Pengguna</h3><button onClick={addUser} className="px-6 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition-all flex items-center gap-2 text-sm"><Icons.Plus size={16}/> Tambah Akun</button></div>
                    <div className="overflow-hidden rounded-2xl border border-slate-100"><table className="w-full text-left"><thead className="bg-slate-50 text-[10px] font-black text-slate-400 uppercase tracking-widest"><tr><th className="px-6 py-4">Username</th><th className="px-6 py-4">Password</th><th className="px-6 py-4 text-right">Aksi</th></tr></thead><tbody className="divide-y divide-slate-100">{users.map((u, i) => (<tr key={u.id || i} className="hover:bg-slate-50/50 transition-colors"><td className="px-6 py-4 font-bold text-slate-800">{u.username} {i===0 && <span className="ml-2 bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded text-[9px] font-black uppercase">Default</span>}</td><td className="px-6 py-4 font-mono text-slate-500 text-sm">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</td><td className="px-6 py-4 text-right"><button onClick={()=>deleteUser(u)} className="p-2 text-slate-400 hover:text-red-500 bg-white border border-slate-200 rounded-lg hover:bg-red-50 transition-all"><Icons.Trash size={16}/></button></td></tr>))}</tbody></table></div>
                </div>
            </div>
        );

        const ResRekapApp = () => {
            const [viewMode, setViewMode] = useState('login'); 
            const [currentUser, setCurrentUser] = useState(null);
            const [participantSession, setParticipantSession] = useState(null);
            const [users, setUsers] = useState([]);
            const [events, setEvents] = useState([]);
            const [savedSheets, setSavedSheets] = useState([]);
            const [settings, setSettings] = useState({ organizerName: "Panitia Pelaksana", appLogo: null });
            const [dbStatus, setDbStatus] = useState('connecting');
            const [tab, setTab] = useState('dashboard');
            const [modal, setModal] = useState({ open: false });
            const [tokenModal, setTokenModal] = useState({ open: false, data: null });
            const [isFullscreen, setIsFullscreen] = useState(false);
            const [pdfData, setPdfData] = useState(null);
            const [previewData, setPreviewData] = useState(null); 
            const [isGeneratingPdf, setIsGeneratingPdf] = useState(false);

            useEffect(() => {
                if (!db) { setDbStatus('error'); return; }
                const unsubEvents = db.collection('events').onSnapshot(snapshot => { setEvents(snapshot.docs.map(doc => doc.data())); setDbStatus('connected'); }, () => setDbStatus('error'));
                const unsubUsers = db.collection('users').onSnapshot(snapshot => {
                    const loadedUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (loadedUsers.length === 0) db.collection('users').add({ username: 'Respati', password: '007' });
                    else setUsers(loadedUsers);
                });
                const unsubSheets = db.collection('saved_sheets').onSnapshot(snapshot => setSavedSheets(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                const unsubSettings = db.collection('meta').doc('settings').onSnapshot(doc => { if (doc.exists) setSettings(doc.data()); else db.collection('meta').doc('settings').set({ organizerName: "Panitia Pelaksana", appLogo: null }); });
                return () => { unsubEvents(); unsubUsers(); unsubSheets(); unsubSettings(); };
            }, []);

            const saveEvent = (eventData) => db.collection('events').doc(eventData.id).set(eventData);
            const deleteEvent = (eventId) => db.collection('events').doc(eventId).delete();
            const saveSheet = (sheetData) => db.collection('saved_sheets').add(sheetData);
            const deleteSheet = (sheetId) => db.collection('saved_sheets').doc(sheetId).delete();
            const saveSettings = (newSettings) => db.collection('meta').doc('settings').set(newSettings);
            const addNewUser = (username, password) => db.collection('users').add({ username, password });
            const removeUser = (userId) => db.collection('users').doc(userId).delete();

            const triggerModal = (title, type, cb, msg, ph, defVal = '', confirmBtnText = null) => { 
                setModal({ open: true, title, type, message: msg, placeholder: ph, defaultValue: defVal, confirmBtnText, onConfirm: (v) => { setModal(prev => ({ ...prev, open: false })); setTimeout(() => cb(v), 150); }, onCancel: () => setModal(prev => ({ ...prev, open: false })) }); 
            };
            const triggerTokenModal = (event, participant, token) => { setTokenModal({ open: true, data: { event, participant, token } }); };
            const toggleFullscreen = () => { if (!document.fullscreenElement) { document.documentElement.requestFullscreen().then(() => setIsFullscreen(true)).catch(console.error); } else { document.exitFullscreen().then(() => setIsFullscreen(false)); } };
            const handleDownloadPDF = (data, filename) => { setPdfData(data); setIsGeneratingPdf(true); setTimeout(() => { generatePDF('pdf-content', filename, () => { setIsGeneratingPdf(false); setPdfData(null); }); }, 1500); };
            const handlePreviewPDF = (data) => setPreviewData(data);
            const handleLogin = (user) => { setCurrentUser(user); setViewMode('admin'); };
            const handleLogout = () => { setViewMode('login'); setCurrentUser(null); setParticipantSession(null); };

            const checkToken = async (tokenInput) => {
                const snapshot = await db.collection('events').get();
                const allEvents = snapshot.docs.map(doc => doc.data());
                for (const ev of allEvents) {
                    const found = ev.participants.find(p => p.token === tokenInput);
                    if (found) { setParticipantSession({ event: ev, participant: found }); setViewMode('participant'); return true; }
                }
                return false;
            };

            const handleAddUser = () => { triggerModal("Tambah Pengguna Baru", "input", (username) => { if(!username) return alert("Wajib diisi"); if(users.some(u => u.username.toLowerCase() === username.toLowerCase())) return alert("Sudah ada"); triggerModal("Set Password", "input", (password) => { if(!password) return alert("Wajib diisi"); addNewUser(username, password); }, null, "Password..."); }, null, "Username..."); };
            const handleDeleteUser = (u) => { if(users.length <= 1) return alert("Tidak bisa menghapus user terakhir."); triggerModal("Hapus User?", "confirm", () => { removeUser(u.id); }, `Hapus akses ${u.username}?`); };

            if (viewMode === 'login') return <LoginView users={users} onLogin={handleLogin} onTokenCheck={checkToken} dbStatus={dbStatus} settings={settings} toggleFullscreen={toggleFullscreen} />;
            if (viewMode === 'participant' && participantSession) return <ParticipantView session={participantSession} onLogout={handleLogout} />;

            return (
                <div className="flex h-screen bg-[#f8fafc] relative">
                    <SimpleModal isOpen={modal.open} {...modal} onCancel={() => setModal({open: false})} />
                    <TokenActionModal isOpen={tokenModal.open} onClose={() => setTokenModal({open: false, data: null})} {...tokenModal.data} />
                    <PreviewModal isOpen={!!previewData} onClose={() => setPreviewData(null)}>{previewData && <PDFContent data={previewData} settings={settings} />}</PreviewModal>
                    {pdfData && <div id="pdf-fullscreen-container"><div id="pdf-content"><PDFContent data={pdfData} settings={settings} /></div></div>}
                    {isGeneratingPdf && <div id="pdf-loading-overlay"><Icons.Loader size={64} className="text-indigo-600 animate-spin mb-6"/><h2 className="text-3xl font-extrabold text-slate-900 tracking-tight">Menyusun Dokumen Digital</h2><p className="text-slate-500 mt-2 font-medium">Mohon tidak menutup aplikasi hingga proses selesai.</p></div>}

                    <aside className="w-64 bg-slate-900 text-white flex flex-col shadow-2xl z-10">
                        <div className="p-6 flex flex-col items-center justify-center mb-4 transition-all hover:bg-white/5 cursor-pointer" title="Klik untuk Fullscreen" onClick={toggleFullscreen}>
                            <div className="flex items-center gap-4 w-full">{settings.appLogo ? <img src={settings.appLogo} className="w-10 h-10 object-contain bg-white/10 rounded-xl p-1.5 border border-white/5"/> : <div className="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center font-black text-xl shadow-lg shadow-indigo-500/20">R</div>}<div><h1 className="font-extrabold text-lg tracking-tight leading-none">ResRekap</h1><p className="text-[9px] text-indigo-400 font-bold tracking-[0.2em] uppercase mt-1">v5.6 Pro Online</p></div></div>
                        </div>
                        <nav className="flex-1 px-3 space-y-1 overflow-y-auto">
                            <SidebarLink active={tab==='dashboard'} icon={<Icons.Dashboard size={18}/>} label="Dashboard" onClick={()=>setTab('dashboard')}/>
                            <SidebarLink active={tab==='events'} icon={<Icons.Event size={18}/>} label="Struktur Lomba" onClick={()=>setTab('events')}/>
                            <SidebarLink active={tab==='recap'} icon={<Icons.Recap size={18}/>} label="Rekapitulasi Nilai" onClick={()=>setTab('recap')}/>
                            <SidebarLink active={tab==='sheets'} icon={<Icons.Sheet size={18}/>} label="Lembar Penilaian" onClick={()=>setTab('sheets')}/>
                            <SidebarLink active={tab==='report'} icon={<Icons.Report size={18}/>} label="Laporan Akhir" onClick={()=>setTab('report')}/>
                            <SidebarLink active={tab==='accounts'} icon={<Icons.UserCog size={18}/>} label="Manajemen Akun" onClick={()=>setTab('accounts')}/>
                            <SidebarLink active={tab==='settings'} icon={<Icons.Settings size={18}/>} label="Konfigurasi" onClick={()=>setTab('settings')}/>
                        </nav>
                        <div className="p-6"><button onClick={handleLogout} className="w-full py-3 bg-red-500/10 hover:bg-red-500 text-red-400 hover:text-white rounded-xl font-bold text-xs flex items-center justify-center gap-2 transition-all"><Icons.LogOut size={14}/> Keluar</button><p className="text-center text-[9px] text-slate-500 font-bold tracking-widest uppercase opacity-40 mt-4">&copy; 2026 ResRekap Team</p></div>
                    </aside>

                    <main className="flex-1 overflow-auto p-10 bg-pattern">
                        <div className="max-w-7xl mx-auto">
                            {tab === 'dashboard' && <DashboardView events={events} setTab={setTab} />}
                            {tab === 'events' && <EventSettings events={events} saveEvent={saveEvent} deleteEvent={deleteEvent} modal={triggerModal} />}
                            {tab === 'recap' && <RecapView events={events} saveEvent={saveEvent} modal={triggerModal} triggerTokenModal={triggerTokenModal} />}
                            {tab === 'sheets' && <SheetGeneratorView events={events} download={handleDownloadPDF} preview={handlePreviewPDF} savedSheets={savedSheets} saveSheet={saveSheet} deleteSheet={deleteSheet} modal={triggerModal}/>} 
                            {tab === 'report' && <ReportView events={events} saveEvent={saveEvent} settings={settings} download={handleDownloadPDF} modal={triggerModal} />}
                            {tab === 'accounts' && <AccountManagerView users={users} addUser={handleAddUser} deleteUser={handleDeleteUser} />}
                            {tab === 'settings' && <AppSettings settings={settings} saveSettings={saveSettings} events={events} saveEvent={saveEvent} modal={triggerModal} />}
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ResRekapApp />);
    </script>
</body>
</html>
